<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Kartenn generator</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">  
  <link rel="stylesheet" href="https://openlayers.org/en/v4.2.0/css/ol.css" type="text/css">
  <link href="../mviewer/lib/font-awesome-4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script src="Sortable.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
  <script src="https://openlayers.org/en/v4.2.0/build/ol.js"></script> 
  <script src="ogc.js"></script>
  <script src="mv.js"></script>
  
  
</head>
<style>
body {
      	width:100%%;
        height:100%;
      
      }
      

.glyphicon-move {
  cursor: move;
  cursor: -webkit-grabbing;
}

.ghost {
  opacity: 1;
  background: #337ab7;
}

.layer-remove, .theme-remove {
  float: right;
  padding-right: 10px;
  color: red;
  font-size: 1.2em;
  cursor: pointer;
}

.layer-edit, .theme-edit{
  float: right;
  padding-right: 10px;
  color: grey;
  cursor: pointer;
  font-size: 1.2em;
}

.btn-layer-new {
  float: right;
  margin-right: 20px;
}


#opt-style option {
    color: #FFFFFF;    
    padding: 5px 0;   
    font-size: 20px;
    font-weight: bold;
}
.alizarin {
    background-color: #E64B3B;   
}
.blue {
    background-color: #F6F7F8;
}
.default {
    background-color: #34495D;
}
.nephritis {
    background-color: #26AE60;
}
.ripe_lemon {
    background-color: #F6CA17;
}
.amethyst {
    background-color: #9A59B6;
}
.carrot {
    background-color: #E67E21;
}
.green {
    background-color: #70BA50;
}
.peter_river {
    background-color: #3497DB;
}
.black {
    background-color: #000000;
}
.chambray {
    background-color: #3A529A;
}
.green_sea {
    background-color: #1ABC9C;
}
.pink {    
    background-color: #F62359;
}
.wet_asphalt {    
    background-color: #34495D;
}

.row.fld.selected {
    background-color: #9E9E9E;
}



#theme-edit-icon {
  font-family: 'FontAwesome', 'sans-serif';
  font-size: 20px;
  height: 45px;
}


div#map_filter {
    height: 300px!important;
}

.ogc-result .thumbnail img {
    max-height: 150px;
}
.ogc-result .thumbnail h3 {
    font-size: 16px;
}
.ogc-result .thumbnail p {
    font-size: smaller;
}

.bl img {
    max-height: 80px;
}

.bl .thumbnail {
    background-color: #dcdada;
}
.bl.visible .thumbnail {
    background-color: #fff;
}
.bl .caption {
    text-align: center;
}

select#opt-style {    
    color: #fff;
}

#frm-lis-styles .caption {
    font-size: xx-small;
}

#frm-lis-styles input[type="text"] { 
    width: 100%;
    background: grey;
    color: white;
    font-size: x-small;
}

#query-parameters {
    display: none;
}

#query-parameters.visible {
    display: block;
}

</style>
<body>   
    <nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Générateur Kartenn</a>
    </div>    
    <ul class="nav navbar-nav navbar-right">
      <li><a role="button" data-toggle="modal" data-target="#mod-importfile" href="#"><span role="button" class="glyphicon glyphicon-import"></span>Importer</a></li>
      <li><a role="button" onclick="saveApplicationParameters(false);" href="#"><span class="glyphicon glyphicon-download"></span>Télécharger</a></li>
      <li><a role="button" onclick="saveApplicationParameters(true);" href="#"><span class="glyphicon glyphicon-globe"></span>Visualiser</a></li>
   </ul>
  </div>
</nav>
    <div class="container">
        <div id="content">
            <ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
                <li class="active"><a href="#application-config" data-toggle="tab">Application</a></li>
                <li><a href="#themes-config" data-toggle="tab">Thématiques</a></li>
                <li><a href="#backgroundlayers-config" data-toggle="tab">Couches de fond</a></li>                            
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="application-config">
                   
                    <form class="form-horizontal">
                        <fieldset>

                        <!-- MAp -->
                        <legend>Paramétrage de l'application</legend>                      
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="map">Etendue géographique</label>  
                          <div class="col-md-4">
                              <div id="map" class="map"></div>
                          </div>
                        </div> 
                       
                         <!-- Title-->
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="opt-title">Titre de l'application</label>  
                          <div class="col-md-4">
                            <input id="opt-title" name="textinput" type="text" placeholder="Kartenn" class="form-control input-md">  
                          </div>
                        </div>

                                                
                        <!-- logo-->
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="opt-logo">Logo</label>  
                          <div class="col-md-4">
                            <input id="opt-logo" name="textinput" type="text" class="form-control input-md">  
                          </div>
                        </div>

                       <!-- help-->
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="opt-help">Fichier d'aide</label>  
                          <div class="col-md-4">
                            <input id="opt-help" name="textinput" type="text" class="form-control input-md" placeholder="mviewer_help.html">  
                          </div>                          
                        </div>
                                                                        
                        <!--style-->
                        <div class="form-group">
                            <label class="control-label" for="frm-style">Style</label> 
                            
                                <select id="opt-style" name="style" class="form-control default"  onchange="updateTheme(this);">                                    
                                    <option class="alizarin" value="css/themes/alizarin.css">alizarin</option>
                                    <option class="blue" value="css/themes/blue.css">blue</option>
                                    <option class="default" selected value="css/themes/default.css">default</option>
                                    <option class="nephritis" value="css/themes/nephritis.css">nephritis</option>
                                    <option class="ripe_lemon" value="css/themes/ripe_lemon.css">ripe_lemon</option>
                                    <option class="amethyst" value="css/themes/amethyst.css">amethyst</option>
                                    <option class="carrot" value="css/themes/carrot.css">carrot</option>
                                    <option class="green" value="css/themes/green.css">green</option>
                                    <option class="peter_river" value="css/themes/peter_river.css">peter_river</option>
                                    <option class="black" value="css/themes/black.css">black</option>
                                    <option class="chambray" value="css/themes/chambray.css">chambray</option>
                                    <option class="green_sea" value="css/themes/green_sea.css">green_sea</option>
                                    <option class="pink" value="css/themes/pink.css">pink</option>
                                    <option class="wet_asphalt" value="css/themes/wet_asphalt.css">wet_asphalt</option>
                                </select>
                            
                      </div>
                      <!--<div class="row">
                          <div class="list-group">
                              <a  class="alizarin list-group-item  col-xs-6 col-md-3">Dapibus ac facilisis in</a>
                              <a  class="blue list-group-item  col-xs-6 col-md-3">Cras sit amet nibh libero</a>
                              <a  class="default list-group-item  col-xs-6 col-md-3">Porta ac consectetur ac</a>
                              <a  class="nephritis list-group-item  col-xs-6 col-md-3">Vestibulum at eros</a>
                         </div>
                     </div>-->
                         
                          <!-- Options -->
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="checkboxes">options</label>
                          <div class="col-md-4">
                          <div class="checkbox">
                            <label for="opt-measuretools">
                              <input type="checkbox" name="checkboxes" id="opt-measuretools">
                              Outils de mesures
                            </label>
                            </div>
                          
                          <div class="checkbox">
                            <label for="opt-exportpng">
                              <input type="checkbox" name="checkboxes" id="opt-exportpng">
                              Export de la carte au format png
                            </label>
                          </div>
                          
                          <div class="checkbox">
                            <label for="opt-showhelp">
                              <input type="checkbox" name="checkboxes" id="opt-showhelp">
                              Afficher l'aide au démarrage
                            </label>
                          </div>
                          
                          <div class="checkbox">
                            <label for="opt-coordinates">
                              <input type="checkbox" name="checkboxes" id="opt-coordinates">
                              Affichage des coordonnées au click
                            </label>
                          </div>                          
                          <div class="checkbox">
                            <label for="opt-togglealllayersfromtheme">
                              <input type="checkbox" name="checkboxes" id="opt-togglealllayersfromtheme">
                              toggle all layers from theme
                            </label>
                          </div>
                          </div>
                        </div>                        
                    

                        </fieldset>
                    </form>
                </div>
                <div class="tab-pane" id="themes-config">
                    <h1>Thématiques</h1>
                     <div class="checkbox">
                        <label for="opt-mini">
                          <input type="checkbox" name="checkboxes" id="opt-mini">
                          Minifier le panneau thématiques
                        </label>
                      </div>
                    <div class="row">                              
                        <div class="col-md-4">
                              <!-- List with handle -->
                              <div id="themes-list" class="list-group">                              
                              </div>
                              <button id="btn-addTheme" class="btn btn-sm btn-primary glyphicon glyphicon-plus sign" onclick="addTheme('Nouvelle thématique', true, createId('theme'));"></button>
                     </div>                   
                     <div class="col-md-4">                   
                        <div id="panel-theme" class="panel panel-default panel-primary" style="display: none;">
                              <div class="panel-heading">
                                <h3 class="panel-title">Thématique</h3>
                              </div>
                              <div class="panel-body" id="theme-edit" data-themeid="">
                                <div class="input-group">
                                  <span class="input-group-addon">Nom</span>
                                  <input type="text" id="theme-edit-title" class="form-control" placeholder="Titre" aria-describedby="basic-addon1">
                                </div>
                                <div class="checkbox">
                                    <label for="theme-edit-collapsed">
                                      <input type="checkbox" name="checkboxes" id="theme-edit-collapsed" value="0">
                                      Déroulée par défaut
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="theme-edit-icon">Icone</label> 
                                    
                                        <select id="theme-edit-icon" name="icon" class="form-control">
                                        </select>
                                    
                              </div>
                                </br>
                                <!-- List with handle -->
                              <div id="themeLayers" class="list-group">                                
                              </div>
                              <button id="btn-addLayer" class="btn btn-sm btn-info glyphicon glyphicon-plus sign" onclick="addLayer('Nouvelle couche');"></button>
                              <button id="btn-saveTheme" class="btn btn-sm btn-success glyphicon glyphicon-ok" onclick="saveTheme();"></button>
                              </div>
                        </div>
                   </div>
                   </div>






                    
                </div>
                <div class="tab-pane" id="backgroundlayers-config">
                    <div class="row">                    
                    <div class="col-sm-6 col-md-6">
                        <h1>Couches de fond</h1>
                    </div>
                    <div class="col-sm-6 col-md-6">
                        <div class="form-group">
                            <label class="control-label" for="frm-bl-mode">Mode d'affichage</label> 
                            <select id="frm-bl-mode" name="bl-mode" class="form-control">                                    
                                <option value="default">normal</option>
                                 <option value="gallery">gallerie</option>                               
                            </select>
                        </div>
                     </div>
                    </div>
                    <div id="frm-bl"></div>
                    <div class="form-group">
                            <label class="control-label" for="frm-bl-mode">Fond affiché au démarrage</label> 
                            <select id="frm-bl-visible" name="bl-visible" class="form-control" onchange="mv.changeVisibleBaseLayer(this.value)" >                                    
                                                                
                            </select>
                        </div>
                </div>
                
            </div> <!-- tab-content-->
        </div>
        
          <!-- Modal file import-->
          <div class="modal fade" id="mod-importfile" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Importer un fichier de configuration</h4>
                </div>
                <div class="modal-body">
                                <div class="alert alert-info">
                                    <input type="file" name="filebutton" style="visibility:hidden;" id="filebutton" />
                                    <label>Choisissez un fichier</label>
                                    <div class="input-append">
                                        <!-- This input is here purely for cosmetic reasons. The actual file is uploaded from the hidden input box !-->
                                        <input type="text" id="subfile" class="input-xlarge">
                                        <a class="btn btn-primary btn-sm" onclick="$('#filebutton').click();">Parcourir</a>
                                    </div>
                               </div>                               
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                </div>
              </div>
            </div>
          </div>
          
          
           <!-- Modal layer options-->
          <div class="modal fade" id="mod-layerOptions" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>                  
                  <h4 class="modal-title">Edition de couche</h4>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" role="tablist" id="layer_sections_menu">    
                        <li role="presentation" class="active"><a href="#layer_conf1"  role="tab" data-toggle="tab">Base</a></li>
                        <li role="presentation" ><a href="#layer_conf2"  role="tab" data-toggle="tab">Fiche d'information</a></li>
                        <li role="presentation" ><a href="#layer_conf3"  role="tab" data-toggle="tab">Affichage</a></li>
                        <li role="presentation" ><a href="#layer_conf4"  role="tab" data-toggle="tab">Filtre source</a></li>
                        <li role="presentation" ><a href="#layer_conf5"  role="tab" data-toggle="tab">Filtre attributaire</a></li>
                    </ul>
                    <div class="tab-content" id="layer_sections">
                    <div role="tabpanel" class="tab-pane active" id="layer_conf1">
                   <form>
                      <div class="form-group">
                        <label for="frm-layer-title">Nom</label>
                        <input type="text" class="form-control" id="frm-name" placeholder="nom de la couche">
                      </div>
                      <div class="form-group">
                        <label for="frm-type">Type</label>
                        <input type="text" class="form-control" id="frm-type" placeholder="type">
                      </div>
                      <div class="form-group">
                        <label for="frm-layerid">id</label>
                        <input type="text" class="form-control" id="frm-layerid" placeholder="id">
                      </div>
                       <div class="form-group">
                        <label for="frm-url">url</label>
                        <input type="text" class="form-control" id="frm-url" placeholder="url">
                      </div>
                       <div class="form-group">
                        <label for="frm-attribution">Attributions</label>
                        <input type="text" class="form-control" id="frm-attribution" placeholder="Attribution">
                      </div>
                      <div class="form-group">
                        <label for="frm-metadata">metadata</label>
                        <input type="text" class="form-control" id="frm-metadata" placeholder="metadata">
                      </div>
                       <div class="form-group">
                        <label for="frm-metadata-csw">metadata</label>
                        <input type="text" class="form-control" id="frm-metadata-csw" placeholder="metadata-csw">
                      </div>
                      <div class="form-group">
                          <div class="checkbox">
                            <label>
                              <input id="frm-tiled" type="checkbox"> Tiled
                            </label>
                          </div>
                        </div>

                    <div class="form-group">
                      <div class="checkbox">
                        <label>
                          <input id="frm-visible" type="checkbox"> Visible
                        </label>
                      </div>
                    </div>
                    <div class="form-group" lang="en-US">
                        <label for="frm-opacity">Opacité</label>
                        <input type="number" class="form-control" id="frm-opacity" placeholder="Opacité (0 à 1)" step="0.1" min="0.1" max="1.0" value="1">
                    </div>
                 </form>
               </div>
               <div role="tabpanel" class="tab-pane" id="layer_conf2">
                  <form>
                    <div class="form-group">
                          <div class="checkbox">
                            <label>
                              <input id="frm-queryable" type="checkbox"> queryable
                            </label>
                          </div>
                      </div>
                      <div class="form-group">
                          <div class="checkbox">
                            <label>
                              <input id="frm-secure" type="checkbox"> Couche protégée
                            </label>
                          </div>
                      </div>
                       <div class="form-group">
                          <div class="checkbox">
                            <label>
                              <input id="frm-searchable" type="checkbox"> searchable
                            </label>
                          </div>
                      </div>
                      <div class="form-group">
                            <label class="control-label" for="frm-infoformat">infoformat</label> 
                            
                                <select id="frm-infoformat" name="infoformat" class="form-control" onchange="mv.showHideQueryParameters(this.value);">                                    
                                    <option value="text/html">text/html</option>
                                    <option value="application/vnd.ogc.gml">application/vnd.ogc.gml</option>                               
                                </select>
                            
                      </div>
                      <div class="form-group">
                        <label for="frm-featurecount">Featurecount</label>
                        <input type="number" class="form-control" id="frm-featurecount" placeholder="Nombre max d'entités retournées" step="1" min="1" max="50" value="5">
                      </div>
                      <div id="query-parameters">
                             <div class="form-group">
                                  <div class="checkbox">
                                    <label>
                                      <input id="frm-template" type="checkbox">Utliser un template
                                    </label>
                                  </div>
                                    <label for="frm-template-url">URL template</label>
                                    <input type="text" class="form-control" id="frm-template-url" placeholder="URL template"/>
                              </div>
                            <div class="form-group">
                                <label class="control-label" for="frm-fields">Champs</label> 
                                <div id="frm-lis-fields">                               
                                </div >
                            </div>
                            
                      </div>

                  </form>
                 </div>
                 
                 
                 <div role="tabpanel" class="tab-pane" id="layer_conf3">
                  <form>
                    
                      <div class="form-group">
                            <label class="control-label" for="frm-styles">Styles</label> 
                            <div class="row" id="frm-lis-styles">                               
                            </div >
                                    <label for="frm-sld">SLD externe</label>
                                    <input type="text" class="form-control" id="frm-sld" placeholder="URL SLD externe"/>
                                    
                                    <label for="frm-legendurl">Légende statique</label>
                                    <input type="text" class="form-control" id="frm-legendurl" placeholder="URL vers Image légende"/>
                                    
                                     <label for="frm-scalemin">Echelle mini</label>
                                    <input type="number" class="form-control" id="frm-scalemin" placeholder="Echelle mini"/>
                                    
                                    <label for="frm-scalemax">Echelle maxi</label>
                                    <input type="number" class="form-control" id="frm-scalemax" placeholder="Echelle maxi"/>
                      </div>
                  </form>
                 </div>
                 
                  <div role="tabpanel" class="tab-pane" id="layer_conf4">
                            <form>                    
                      
                                <div class="form-group">
                                    <label for="frm-filter">filtre actif</label>
                                    <input type="textarea" class="form-control" id="frm-filter" placeholder="filtre cql">
                                 </div>
                                 <!-- Nav tabs -->
                                  <ul class="nav nav-tabs" role="tablist">
                                    <li role="presentation" class="active" ><a href="#attribute_filter" aria-controls="attribute_filter" role="tab" data-toggle="tab">Filtre attributaire</a></li>
                                    <li role="presentation" ><a href="#geo_filter" aria-controls="geo_filter" role="tab" data-toggle="tab">Filtre géographique</a></li> 
                                  </ul>
                                  <!-- Tab panes -->
                                  <div class="tab-content">
                                        <div role="tabpanel" class="tab-pane active" id="attribute_filter">
                                                <div class="form-group">
                                                    <label class="control-label" >Champs</label>                                                    
                                                        <select id="attribute_filter_fields" name="fields" class="form-control" onchange="extractFeatures(this.value, 'source')";>
                                                        </select>
                                                  </div>
                                                  <div class="form-group">
                                                    <label class="control-label" >Opérateur</label>                                                    
                                                        <select id="attribute_filter_operators" name="operators" class="form-control">
                                                            <option value="=">=</option>
                                                            <option value="IN">IN</option>
                                                            <option value="NOT IN">NOT IN</option>
                                                        </select>
                                                   </div>
                                                   <label class="control-label" >valeurs sélectionnées</label>
                                                   <div class="form-group">                                                        
                                                        <input type="text" value="" data-role="tagsinput" id="source_fields_tags" class="form-control"/>
                                                   </div>
                                                            <div class="col-md-6" style="padding-top: 25px;">
                                                                <button type="button" onclick="mv.saveSourceAttributeFilter()" class="btn btn-default">Appliquer</button>
                                                            </div>
                                                             
                                        </div>
                                                                   
                                        <div role="tabpanel" class="tab-pane" id="geo_filter">
                                            <div id="map_filter" class="map" ></div>
                                        </div>
                                  </div> 
                            </form>
                        </div>
                 
                  <div role="tabpanel" class="tab-pane" id="layer_conf5">
                  <form>
                    
                      <div class="form-group">
                                <div class="form-group">
                                    <label for="frm-attributelabel">Label</label>
                                    <input type="textarea" class="form-control" id="frm-attributelabel" placeholder="Texte à afficher">
                                 </div>                                
                                 
                                <div class="form-group">
                                    <label class="control-label" >Champs</label>                                                    
                                        <select id="opt-attributefield" name="fields" class="form-control" onchange="extractFeatures(this.value,'control')";>
                                        </select>
                                        <label class="control-label" >valeurs sélectionnées</label>
                                           <div class="form-group">                                                        
                                                <input type="text" value="" data-role="tagsinput" id="control_fields_tags" class="form-control"/>
                                           </div>                                       
                              </div>
                                                                
                      </div>

                  </form>
                 </div>
                 
                 
                 </div>
                </div>
                <div class="modal-footer">
                  <button type="button" onclick="mv.saveLayerOptions()" class="btn btn-default">Enregistrer</button>
                  <button type="button" onclick="mv.form2xml()" class="btn btn-default">Voir</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                </div>
              </div>
            </div>
          </div>
          
           <!-- Modal codeView-->
          <div class="modal fade" id="mod-codeview" role="dialog">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Configuration XML</h4>
                </div>
                <div class="modal-body">
                        <div class="row">
                            <pre></pre>
                          </div><!-- /.row -->
                        
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal featuresView-->
          <div class="modal fade" id="mod-featuresview" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Extraction de données</h4>
                </div>
                <div class="modal-body">
                        <div class="row">
                             <div class="col-md-6">
                                 <label class="control-label" >Valeurs</label>
                                 <div id="distinct_values" class="list-group"></div>
                            </div>
                          </div><!-- /.row -->
                        
                </div>

              </div>
            </div>
          </div>
          
           <!-- Modal new Layer-->
          <div class="modal fade" id="mod-layerNew" role="dialog">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Nouvelle(s) couche(s)</h4>
                </div>
                <div class="modal-body">
                        <div class="row">
                             <div class="col-lg-6">
                                <div class="input-group">
                                  <input type="text" id="input-ogc-filter" class="form-control" aria-label="..." placeholder="Rechercher...">
                                  <div class="input-group-btn">
                                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Providers<span class="caret"></span></button>
                                    <ul class="dropdown-menu dropdown-menu-right">
                                      <li class="active" ><a data-providertype="csw" data-provider="https://geobretagne.fr/geonetwork/srv/fre/csw" data-metadata-app="https://geobretagne.fr/geonetwork/apps/georchestra/" href="#">Catalogue géoBretagne</a></li>
                                      <li><a data-providertype="csw" data-provider="http://applications.region-bretagne.fr/geonetwork/srv/fre/csw" data-metadata-app="http://applications.region-bretagne.fr/geonetwork/" href="#">Catalogue de la Région</a></li>    
                                       <li><a data-providertype="csw" data-provider="https://www.cigalsace.org/geonetwork/srv/fre/csw" data-metadata-app="https://www.cigalsace.org/geonetwork/" href="#">Catalogue de la Région Grand Est</a></li>
                                       <li><a data-providertype="csw" data-provider="../proxy/?url=http://www.geopal.org/geonetwork/srv/fre/csw" data-metadata-app="http://www.geopal.org/geonetwork/" href="#">Catalogue de la Région Pays de la Loire</a></li>

                                       
                                      <li role="separator" class="divider"></li>
                                      <li><a data-providertype="wms" data-provider="http://ows.region-bretagne.fr/geoserver/rb/wms" href="#">Serveur WMS de la Région</a></li>
                                      <li><a href="#">Serveur WFS</a></li>
                                    </ul>
                                    <button type="button" class="btn btn-critical" onclick="mv.search()" >Rechercher</button>
                                  </div><!-- /btn-group -->
                                </div><!-- /input-group -->
                              </div><!-- /.col-lg-6 -->
                          </div><!-- /.row -->
                         <div class="row ogc-results" id="csw-results" style="display: none;"></div>
                         <div class="row ogc-results" id="wms-results" style="display: none;"></div>
                         <div class="row ogc-results" id="wfs-results" style="display: none;"></div>
                         </div>
                         <div class="modal-footer">
                          <button type="button" class="btn btn-success" onclick="mv.getConfLayers();">Sélectionner</button>
                          <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                        </div>
                </div>
                
              </div>
            </div>
          </div>
        
        
        
    </div>
    <script>
        $(document).ready(function(){
             $('#tabs').tab();
             $.get("icons-fontawesome.html",function( data ) {
                $("#theme-edit-icon").append(data);
                $("#theme-edit-icon option").each(function(i, el) {
                    $(el).attr("value", $.trim($(el).text().split("[")[0]));
                });
             });
             
	  });
      //EPSG:2154
      proj4.defs("EPSG:2154","+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
        //Map      
      
      var map = new ol.Map({
                layers: [
                  new ol.layer.Tile({
                    source: new ol.source.OSM()
                  })
                ],
                target: 'map',
                view: new ol.View({
                  center: [-307903.74898791354, 6141345.088741366],
                  zoom: 7
                })
      });
      
      var savedParameters;
      
      //Map_filter
      var draw;
      var source = new ol.source.Vector({wrapX: false});
      var vector = new ol.layer.Vector({
        source: source
      });
      var map2 = new ol.Map({
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          vector
        ],
        target: 'map_filter',
        view: new ol.View({
          center: [-307903.74898791354, 6141345.088741366],
          zoom: 7
        })
      });
      var config;
      
      var newConfiguration = function () {            
            ["opt-title", "opt-logo", "opt-help", "theme-edit-icon", "theme-edit-title"].forEach(function (param, id) {
                $("#"+param).val("");
            });
            ["opt-exportpng", "opt-measuretools", "theme-edit-collapsed", "opt-mini", "opt-showhelp", "opt-coordinates", "opt-togglealllayersfromtheme"].forEach(function (param, id) {
                $("#"+param).prop('checked', false);
            });            
            
            $("#opt-style").val("css/themes/default.css").trigger("change");
            $("#theme-edit-icon option").prop("selected", false);
            $("#panel-theme").hide();
            
            map.getView().setCenter([-307903.74898791354, 6141345.088741366]);
            map.getView().setZoom(7);
            config = {
                application: { title: "", logo: "" },
                themes: {},
                temp : { layers : {}}
            };
            //Store des parametres non gérés
            savedParameters = {"application":[]};
            $(".list-group-item").remove();
            //Sélection par défaut des 2 1er baselayers
            $(".bl:first input, .bl:nth-child(2) input").prop("checked", true).trigger("change");
            $("#frm-bl-visible").val($("#frm-bl-visible option:not(:disabled)").first().val());
      };
      
      
      var loadLayers = function (themeid) {
            var theme = config.themes[themeid];
            if (theme) {
                $.each(theme.layers, function (index, layer) {
                        addLayer(layer.title, layer.id);
                 });
            }
      };
      
              
         
      var bl = {};
      
      
      bl["positron"] = {
        id:"positron", thumbgallery: "../mviewer/img/basemap/positron.png", title:"CartoDb", label:"Positron", 
        definition: ['<baselayer  visible="false" type="OSM" id="positron" label="Positron" title="CartoDb" thumbgallery="img/basemap/positron.png" ', 
			'url="http://{a-c}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png" maxzoom="20" ',
			'attribution="Map tiles by  &lt;a href=\'http://cartodb.com/attributions\'>CartoDb &lt;/a>, under  &lt;a href=\'http://creativecommons.org/licenses/by/3.0/\'>CC BY 3.0 &lt;/a>" />'].join("")
      };
      
      bl["esriworldimagery"] = {
        id:"esriworldimagery", thumbgallery: "../mviewer/img/basemap/esriworldwide.jpg", title:"Esri world imagery", label: "Esri World imagery",
        definition: ['<baselayer visible="false" type="OSM" id="esriworldimagery" label="Esri world imagery" title="Esri world imagery" ',
            'thumbgallery="img/basemap/esriworldwide.jpg" url="http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}" ',
            'attribution="Esri world imagery"/>'].join("")};
      
       bl["stamen1"] = {
        id:"stamen1", thumbgallery: "../mviewer/img/basemap/toner-lite.png", title:"Stamen Design", label:"Toner-lite", 
        definition: ['<baselayer  visible="false" type="OSM" id="stamen1" label="Toner-lite" title="Stamen Design" thumbgallery="img/basemap/toner-lite.png" ',
			'url="http://{a-d}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png" maxzoom="20" ',
			' attribution="Map tiles by  &lt;a href=\'http://stamen.com/\'>Stamen Design &lt;/a>, under  &lt;a href=\'http://creativecommons.org/licenses/by/3.0/\'>CC BY 3.0 &lt;/a>" />'].join("")
      };
      bl["stamen2"] = {
        id:"stamen2", thumbgallery: "../mviewer/img/basemap/watercolor.jpg", title:"Stamen Design", label:"Watercolor", 
        definition: [' <baselayer  visible="false" type="OSM" id="stamen2" label="Watercolor" title="Stamen Design" thumbgallery="img/basemap/watercolor.jpg" ',
			'url="http://{a-c}.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg" maxzoom="20" ',
			' attribution="Map tiles by  &lt;a href=\'http://stamen.com/\'>Stamen Design &lt;/a>, under  &lt;a href=\'http://creativecommons.org/licenses/by/3.0/\'>CC BY 3.0 &lt;/a>" />'].join("")
      };
      
       bl["darkmatter"] = {
        id:"darkmatter", thumbgallery: "../mviewer/img/basemap/darkmatter.png", title:"CartoDb", label:"Dark Matter", 
        definition: [' <baselayer  visible="false" type="OSM" id="darkmatter" label="Dark Matter" title="CartoDb" thumbgallery="img/basemap/darkmatter.png" ',
			'url="http://{a-c}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png" maxzoom="20" ',
			' attribution="Map tiles by  &lt;a href=\'http://cartodb.com/attributions\'>CartoDb &lt;/a>, under  &lt;a href=\'http://creativecommons.org/licenses/by/3.0/\'>CC BY 3.0 &lt;/a>" />'].join("")
      };
      
      bl["ortho1"] = {
        id:"ortho1", thumbgallery: "../mviewer/img/basemap/ortho.jpg", title:"GéoBretagne", label:"Photo aérienne actuelle", 
        definition: ['<baselayer  visible="false" type="WMTS" id="ortho1" label="Photo aérienne actuelle"',
        '   title="GéoBretagne" thumbgallery="img/basemap/ortho.jpg" url="http://tile.geobretagne.fr/gwc02/service/wmts"',
        '   layers="satellite" format="image/png" style="_null" matrixset="EPSG:3857" fromcapacity="false"',
        '   attribution="&lt;a href=\'http://applications.region-bretagne.fr/geonetwork/?uuid=3a0ac2e3-7af1-4dec-9f36-dae6b5a8c731\' target=\'_blank\' >partenaires GéoBretagne - IGN RGE BD ORTHO - PlanetObserver&lt;/a>" />'].join("")
      };
       bl["ortho_ir"] = {
        id:"ortho_ir", thumbgallery: "../mviewer/img/basemap/ir.jpg", title:"GéoBretagne", label:"Photo aérienne infra rouge", 
        definition: ['<baselayer  visible="false" type="WMTS" id="ortho_ir" label="Photo aérienne infra rouge"',
        '   title="GéoBretagne" thumbgallery="img/basemap/ir.jpg" url="http://geobretagne.fr/geoserver/gwc/service/wmts"',
        '   layers="photo:ir-composite" format="image/jpeg" style="_null" matrixset="EPSG:3857" fromcapacity="false"',
        '   attribution="&lt;a href=\'https://geobretagne.fr/geonetwork/apps/georchestra/?uuid=434b82a8-8d3c-4d9f-9eb3-0485f1a63eb6\' target=\'_blank\' >partenaires GéoBretagne - IGN RGE BD ORTHO - PlanetObserver&lt;/a>" />'].join("")
      };
      bl["osm_google"] = {
        id:"osm_google", thumbgallery: "../mviewer/img/basemap/osm_google.png", title:"GéoBretagne", label: "OpenStreetMap",
        definition: ['<baselayer  visible="false" type="WMS" id="osm_google" label="OpenStreetMap" title="Plan OSM Géobretagne" thumbgallery="img/basemap/osm_google.png" ',
            'url="http://osm.geobretagne.fr/gwc01/service/wms" layers="osm:google" format="image/png" ',
            'attribution="GéoBretagne. Données : les contributeurs d\'&lt;a href=\'http://www.openstreetmap.org/\' target=\'_blank\'>OpenStreetMap &lt;/a>,  &lt;a href=\'http://www.openstreetmap.org/copyright\' target=\'_blank\'>ODbL &lt;/a>" />'].join("")
      };
      bl["osm"] = {
        id:"osm", thumbgallery: "../mviewer/img/basemap/osm.png", title:"OpenStreetMap", label:"OpenStreetMap", 
        definition: ['<baselayer  visible="false" type="OSM" id="osm" label="OpenStreetMap" title="OpenStreetMap" thumbgallery="img/basemap/osm.png" ',
            'url="http://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png" ',
            'attribution="Données : les contributeurs d\'&lt;a href=\'http://www.openstreetmap.org/\' target=\'_blank\'>OpenStreetMap &lt;/a>&lt;a href=\'http://www.openstreetmap.org/copyright\' target=\'_blank\'>ODbL &lt;/a>" />'].join("")
      };      
      
      mv.showBaseLayers(bl);      
      
      var sortableLayerList = Sortable.create(document.getElementById('themeLayers'), {
          handle: '.glyphicon-move',          
          animation: 150,
          ghostClass: 'ghost',
          filter: '.layer-remove',
          onFilter: function (evt) {
            var el = sortableLayerList.closest(evt.item); // get dragged item
            deleteLayer(el.getAttribute('data-layerid'));
            el && el.parentNode.removeChild(el);
          }
        });
        
       var sortableThemeList = Sortable.create(document.getElementById('themes-list'), {
          handle: '.glyphicon-move',          
          animation: 150,
          ghostClass: 'ghost',
          filter: '.theme-remove',
          onFilter: function (evt) {
            var el = sortableThemeList.closest(evt.item); // get dragged item
            var themeid = $(el).attr("data-themeid");
            deleteTheme(themeid);
            el && el.parentNode.removeChild(el);
          }
        });
      
      $('input[type=file]').change(function () {
            loadApplicationParameters();
        });
        
      $(".dropdown-menu li a").click(function(){
         $(this).parent().parent().find(".active").removeClass("active");
         var url = $(this).data("provider");
         var type = $(this).data("providertype");
         $(this).parent().addClass("active");
         //ogc.setLayerFinderMode({type: type, url: url });
     });
     
         
     var addLayer = function (title, layerid) {
        // test if theme is saved
        if (!config.themes[$("#theme-edit").attr("data-themeid")]) {
            saveTheme();
        }
        $("#themeLayers").append(['<div class="list-group-item layers-list-item" data-layerid="'+layerid+'">',
            '<span class="glyphicon glyphicon-move" aria-hidden="true"></span>',
            '<span class="layer-remove glyphicon glyphicon-remove" title="Supprimer" ></span>',
            '<span class="layer-edit glyphicon glyphicon-pencil" title="Editer cette couche" onclick="editLayer(this);"></span>',
            '<span class="layer-name">'+title+'</span>',
            '</div>'].join(""));
     };
     
     var editLayer = function (item) {        
        $("#themeLayers .list-group-item").removeClass("active");
        $(item).parent().addClass("active");        
        var title = $(item).parent().find(".layer-name").text();
        var layerid = $(item).parent().attr("data-layerid");        
        if (layerid != "undefined") {            
            $("#mod-layerOptions").modal();
            mv.showLayerOptions($(item).parent());            
        } else {
            $("#mod-layerNew").modal();
        }        
     };
     
     var addTheme = function (title, collapsed, themeid, icon) {
        $("#themes-list").append(['<div class="list-group-item themes-list-item" data-theme="'+title+'" data-themeid="'+themeid+'" data-theme-collapsed="'+collapsed+'" data-theme-icon="'+icon+'">',
            '<span class="glyphicon glyphicon-move" aria-hidden="true"></span>',
            '<span class="badge">0</span>',
            '<span class="theme-remove glyphicon glyphicon-remove" title="Supprimer"></span>',
            '<span class="theme-edit glyphicon glyphicon-pencil" title="Editer ce thème" onclick="editTheme(this);"></span>',
            '<span class="theme-name">'+title+'</span></div>'].join(""));
            config.themes[themeid] = {
                title:title,
                id: themeid,
                icon: icon,
                collapsed: collapsed,
                layers: []
            };
     };
     
     var editTheme = function (item) {
        $("#themes-list .list-group-item").removeClass("active");
        $(item).parent().addClass("active");
        var title = $(item).parent().attr("data-theme");
        var themeid = $(item).parent().attr("data-themeid");
        var collapsed = ($(item).parent().attr("data-theme-collapsed")==="true")?false:true;
        var icon = $(item).parent().attr("data-theme-icon");
        $("#panel-theme").show();
        $("#theme-edit-title").val(title);
        $("#theme-edit-collapsed").prop('checked', collapsed);
        $("#theme-edit").attr("data-themeid", themeid);
        $("#theme-edit-icon").val(icon);
        $("#theme-edit-icon option[value='"+icon+"']").prop("selected", true);
        //Remove old layers entries
        $(".layers-list-item").remove();
        //Show layerslm
        loadLayers(themeid);
     };
     
     var saveTheme = function () {
        //get active item in left panel
        var theme = $("#themes-list .active");
        //get edited values (right panel)
        var title = $("#theme-edit-title").val();        
        var themeid = $("#theme-edit").attr("data-themeid");
        var collapsed = !$("#theme-edit-collapsed").prop('checked');
        var icon = $.trim($("#theme-edit-icon").val());
        //update values in left panel
        theme.attr("data-theme", title);      
        theme.attr("data-theme-collapsed", collapsed);
        theme.attr("data-theme-icon", icon);
        theme.find(".theme-name").text(title);
        var nb_layers = $("#themeLayers .list-group-item").length;
        theme.find(".badge").text(nb_layers);
        //deactivate theme edition
        $("#themes-list .list-group-item").removeClass("active");
        $("#panel-theme").hide();
        
        //save theme locally
        config.themes[themeid].title = title;
        config.themes[themeid].id = themeid;
        config.themes[themeid].collapsed = collapsed;
        config.themes[themeid].icon = icon;
         
        
     };
     
     var deleteTheme = function (themeid) {
        $("#panel-theme").hide();
        delete config.themes[themeid];
     };
     
     var deleteLayer = function (layerid) {
        var themeid = $("#theme-edit").attr("data-themeid");
        var index = config.themes[themeid].layers.findIndex(function(l){return l.id === layerid});
        config.themes[themeid].layers.splice(index, 1);
     };
     
     var createId = function (obj) {
        var d = new Date();
        var df = d.getFullYear() + ("0"+(d.getMonth()+1)).slice(-2)+
            ("0" + d.getDate()).slice(-2) + ("0" + d.getHours()).slice(-2) + ("0" + d.getMinutes()).slice(-2) + ("0" + d.getSeconds()).slice(-2);
        return obj+'-' + df;
     };
        
      var saveApplicationParameters = function (option) {
         var padding = function (n) {
            return '\r\n' + " ".repeat(n);
         };
         var savedProxy = "";
         var savedOlscompletion = "";
         var savedElasticsearch = "";
         var savedSearchparameters = "";
         var application = ['<application',
            'title="'+$("#opt-title").val()+'"',            
            'logo="'+$("#opt-logo").val()+'"',
            'help="'+$("#opt-help").val()+'"',            
            'style="'+$("#opt-style").val()+'"',  
            'exportpng="'+($('#opt-exportpng').prop('checked')=== true)+'"',            
            'showhelp="'+($('#opt-showhelp').prop('checked')=== true)+'"',
            'coordinates="'+($('#opt-coordinates').prop('checked')=== true)+'"',
            'measuretools="'+($('#opt-measuretools').prop('checked')=== true)+'"',
            'togglealllayersfromtheme="'+($('#opt-togglealllayersfromtheme').prop('checked')=== true)+'"'];
            
         savedParameters.application.forEach(function(parameter, id){
            $.each(parameter,function(prop,val) {
                console.log(prop,val)
                application.push(prop+'="'+val+'"');
            });
         });
         application = application.join(padding(4)) + '>'+padding(0)+'</application>';
         if ( savedParameters.proxy  ) {
            savedProxy = padding(0) + savedParameters.proxy;
         }
         if ( savedParameters.olscompletion  ) {
            savedOlscompletion = padding(0) + savedParameters.olscompletion;
         }
         if ( savedParameters.elasticsearch  ) {
            savedElasticsearch = padding(0) + savedParameters.elasticsearch;
         }
         if ( savedParameters.searchparameters  ) {
            savedSearchparameters = padding(0) + savedParameters.searchparameters;
         }   
         var center = map.getView().getCenter().join(",");
         var zoom = map.getView().getZoom();
         var mapoptions = padding(0) + '<mapoptions maxzoom="20" projection="EPSG:3857" center="'+center+'" zoom="'+zoom+'" />';
            
         var baseLayersMode = $("#frm-bl-mode").val();
         var visibleBaselayer = $("#frm-bl-visible").val();
         var baseLayers =   [padding(0) + '<baselayers style="'+baseLayersMode+'">'];
         $(".bl input:checked").each(function (i, b) {
            // set first bl visible
            var baseLayer = bl[$(b).parent().parent().attr("data-layerid")];
            var definition = baseLayer.definition;
            if (baseLayer.id === visibleBaselayer) {
                definition = definition.replace('visible="false"', 'visible="true"');
            }
            baseLayers.push(padding(4) + definition);
         });
         baseLayers.push(padding(0)+'</baselayers>');
         var themes = [ padding(0)+ '<themes mini="'+($('#opt-mini').prop('checked')=== true)+'">'];
         $.each(config.themes, function (i, t) {            
            var theme = [padding(4)+'<theme id="'+t.id+'" name="'+t.title+'" collapsed="'+t.collapsed+'" icon="'+t.icon+'">'];
            $(t.layers).each (function (i, l) {
                var layer = mv.writeLayerNode(l);
                theme.push(layer);
            });
            themes.push(theme.join(" "));
            themes.push(padding(4)+'</theme>');
         });
         themes.push(padding(0)+'</themes>');
                     
         var conf = ['<config>\r\n',
            application,
            mapoptions,
            savedProxy,
            savedOlscompletion,
            savedElasticsearch,
            savedSearchparameters,
            baseLayers.join(" "),
            themes.join(" "),
            padding(0)+ '</config>'];
         
         if (option) {         
                 $.ajax({
                  type: "POST",
                  url: "store.php",
                  data: conf.join(""),
                  success: function( data ) {
                    if (data.success && data.url) {
                    console.log(data.url);
                    window.open(data.url,'_blank');
                    }
                  }
                });
          } else {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/xml;charset=utf-8,' +      encodeURI(conf.join("")));
            element.setAttribute('download', "config.xml");
            element.click();            
          }
        
      };
      
      var addgeoFilter = function () {
          var layername = $(".layers-list-item.active").attr("data-layerid");
          map2.updateSize();
          draw = new ol.interaction.Draw({
            source: source,
            type: "Polygon"
          });
          draw.on('drawend', function (e) {
            source.clear();
            var currentFeature = e.feature;//this is the feature fired the event
            var layer = config.temp.layers[layername];
            var projGeom = e.feature.getGeometry().clone().transform('EPSG:3857',layer.projection);
            var format = new ol.format.WKT();
            var wktRepresenation  = format.writeGeometry(projGeom);            
            $("#frm-filter").val('INTERSECTS('+layer.geometry+ ',' + wktRepresenation + ')');
          });
          map2.addInteraction(draw);        
      };
      
      var extractFeatures = function (fld, option) {        
        var layerid = $(".layers-list-item.active").attr("data-layerid");
        var layer = config.temp.layers[layerid];        
        ogc.getFeatures(layer.wfs_url,layerid,fld, option);
      };
      
      var  loadApplicationParameters = function () {
        var file = document.getElementById("filebutton").files[0];
        if (file) {
            var reader = new FileReader();
            reader.readAsText(file, "UTF-8");
            reader.onload = function (evt) {
                newConfiguration();
                var xml = $.parseXML(evt.target.result);
                console.log(xml);
                var proxy = $(xml).find("proxy");
                var olscompletion = $(xml).find("olscompletion");
                var elasticsearch = $(xml).find("elasticsearch");
                var searchparameters = $(xml).find("searchparameters");                
                [proxy, olscompletion, elasticsearch, searchparameters].forEach(function(param,id) {
                    // this parameters are not yet supported but must be saved for later
                    if (param.length>0) {
                        savedParameters[param.selector] = param[0].outerHTML;
                    }
                });
                //Application                
                var application = $(xml).find("application");                
                ["stats", "statsurl"].forEach(function(param,id) {
                   // this parameters are not yet supported but must be saved for later
                   var parameter = new Object();
                   if (application.attr(param)) {
                       parameter[param] = application.attr(param);
                       savedParameters.application.push(parameter);
                   }
                });                
                ["title", "logo", "help", "style"].forEach(function(value,id) {
                    if (application.attr(value)) {
                        $("#opt-" + value).val(application.attr(value));
                    }
                    if (value === "style") {
                        updateTheme($("#opt-" + value)[0]);
                    }
                }); 
                
                ["exportpng", "measuretools", "showhelp", "coordinates", "togglealllayersfromtheme"].forEach(function(value,id) {
                    if (application.attr(value) && application.attr(value) === "true") {
                        $("#opt-" + value).prop("checked", true);
                    }
                });
                //Mapoptions
                var mapoptions = $(xml).find("mapoptions");                
                ["projection", "maxzoom"].forEach(function(value,id) {
                    if (mapoptions.attr(value)) {
                        $("#opt-" + value).val(mapoptions.attr(value));
                    }
                });               
                map.getView().setCenter(mapoptions.attr("center").split(",").map(Number));
                map.getView().setZoom(parseInt(mapoptions.attr("zoom")));
                //BaseLayers
                var baseLayersMode = $(xml).find("baselayers").attr("mode") || "default";
                $("#frm-bl-mode").val(baseLayersMode);
                var baselayers = $(xml).find("baselayer");
                //Reinitialisation
                $(".bl input").prop("checked",false);
                $("#frm-bl-visible option").attr('disabled', 'disabled');
                baselayers.each(function(id, bl) {
                    var id = $(bl).attr("id");
                    $("#frm-bl .bl[data-layerid='"+id+"'] input").prop("checked",true).trigger('change');
                });
                var visibleBaselayer = $(xml).find('baselayer[visible="true"]').attr("id");
                $("#frm-bl-visible").val(visibleBaselayer).trigger('change');
                //tHEMES & layers
                var themePanel =  $(xml).find("themes");                
                if (themePanel.attr("mini") === "true") {
                    $('#opt-mini').prop('checked', true);
                }
                var themes = $(xml).find("theme");
                themes.each(function(id, th) {                    
                    addTheme ($(th).attr("name"), ($(th).attr("collapsed") || true), $(th).attr("id"), $(th).attr("icon"));
                    var layers = $(th).find("layer");
                    layers.each(function(id, l) {
                        
                        var layer = {
                            id: $(l).attr("id"),
                            type: $(l).attr("type") || "wms",
                            tiled: ($(l).attr("tiled") === "true"),
                            scalemin: $(l).attr("scalemin"),
                            scalemax: $(l).attr("scalemax"),
                            title: $(l).attr("name"),
                            name: $(l).attr("name"),
                            url: $(l).attr("url"),
                            queryable: ($(l).attr("queryable") === "true"),
                            featurecount: $(l).attr("featurecount"),
                            searchable: ($(l).attr("searchable") === "true"),
                            secure: ($(l).attr("secure") === "true"),
                            infoformat: $(l).attr("infoformat"),
                            metadata: $(l).attr("metadata"),
                            "metadata-csw": mv.escapeXml($(l).attr("metadata-csw")),
                            attribution: $(l).attr("attribution"),
                            filter: $(l).attr("filter"),
                            visible: ($(l).attr("visible") === "true"),
                            opacity: $(l).attr("opacity"),
                            template: $(l).find("template").text(),
                            usetemplate: ($(l).find("template") && $(l).find("template").text().length > 3 || ($(l).find("template").attr("url") && ($(l).find("template").attr("url").length>1))),
                            templateurl : false,
                            fields:  $(l).attr("fields"),
                            fieldsoptions : false,
                            aliases:  $(l).attr("aliases"),
                            style:  $(l).attr("style"),
                            stylesalias:  $(l).attr("stylesalias"),
                            sld: $(l).attr("sld"),
                            legendurl: $(l).attr("legendurl"),
                            attributefilter: ($(l).attr("attributefilter") === "true")
                        };
                        if (layer.attributefilter) {
                            layer.attributefield = $(l).attr("attributefield");
                            layer.attributelabel = $(l).attr("attributelabel");
                            layer.attributevalues = $(l).attr("attributevalues");
                        }
                        if (layer.usetemplate === true && $(l).find("template").attr("url")) {
                            layer.templateurl = $(l).find("template").attr("url");
                            console.log(layer.templateurl);                            
                        }
                        $("#frm-template").prop("checked", (layer.usetemplate)); 
                        if (layer.fields && layer.aliases) {
                            layer.fieldsoptions = {};            
                            $(layer.fields.split(",")).each(function (index, fld) {
                                var type = "text";                                
                                var alias = layer.aliases.split(",")[index];                
                                layer.fieldsoptions[fld] = {"name": fld, "alias": alias, "type": type};                
                            });
                        }
                        config.themes[$(th).attr("id")].layers.push(layer);
                        
                    });
                });
                
                $("#mod-importfile").modal("hide");
            }
            reader.onerror = function (evt) {
                alert("error reading file");
            }
        }
      };
      
      /*var search = function () {
        mv.resetSearch();
        ogc.cswSearch();
      };*/
      
      var updateTheme = function (el) {
        console.log(el);
        var cls = $("#"+el.id+" option[value='"+el.value+"']").text();
        $(el).removeClass().addClass("form-control " + cls);
      
      };
      
      newConfiguration();
      
      $('#mod-featuresview').on('hidden.bs.modal', function () {
            var option = $(this).attr("data-target");
            var target = "";
            if (option === 'source') { target = "#source_fields_tags"; }
            if (option === 'control') { target = "#control_fields_tags"; }
            $("#distinct_values a.active").each(function (id, fld) {                
                  $(target).tagsinput('add', $(fld).text());
            });
      });
      
      $('a[href="#geo_filter"]').on('shown.bs.tab', function (e) {
          addgeoFilter();
      });
      
      
    </script>


</body>
</html>