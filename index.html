<!DOCTYPE html>
<html lang="fr">
<head>
  <title>mviewer studio</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">  
  <link rel="stylesheet" href="https://openlayers.org/en/v4.2.0/css/ol.css" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script src="lib/Sortable.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
  <script src="https://openlayers.org/en/v4.2.0/build/ol.js"></script> 
  <script src="lib/ogc.js"></script>
  <script src="lib/mv.js"></script>
  
  
</head>
<style>
body {
      	width:100%%;
        height:100%;
      
      }
      

.glyphicon-move {
  cursor: move;
  cursor: -webkit-grabbing;
}

.ghost {
  opacity: 1;
  background: #337ab7;
}

.layer-remove, .theme-remove {
  float: right;
  padding-right: 10px;
  color: #000000;
  font-size: 1.2em;
  cursor: pointer;
}

.layer-edit, .theme-edit{
  float: right;
  padding-right: 10px;
  color: #000000;
  cursor: pointer;
  font-size: 1.2em;
}

.btn-layer-new {
  float: right;
  margin-right: 20px;
}


#opt-style option {
    color: #FFFFFF;    
    padding: 5px 0;   
    font-size: 20px;
    font-weight: bold;
}
.alizarin {
    background-color: #E64B3B;   
}
.blue {
    background-color: #F6F7F8;
}
.default {
    background-color: #34495D;
}
.nephritis {
    background-color: #26AE60;
}
.ripe_lemon {
    background-color: #F6CA17;
}
.amethyst {
    background-color: #9A59B6;
}
.carrot {
    background-color: #E67E21;
}
.green {
    background-color: #70BA50;
}
.peter_river {
    background-color: #3497DB;
}
.black {
    background-color: #000000;
}
.chambray {
    background-color: #3A529A;
}
.green_sea {
    background-color: #1ABC9C;
}
.pink {    
    background-color: #F62359;
}
.wet_asphalt {    
    background-color: #34495D;
}

.row.fld.selected {
    background-color: #9E9E9E;
}



#theme-edit-icon {
  font-family: 'FontAwesome', 'sans-serif';
  font-size: 20px;
  height: 45px;
}


div#map_filter {
    height: 300px!important;
}

.ogc-result .thumbnail img {
    max-height: 150px;
}
.ogc-result .thumbnail h3 {
    font-size: 16px;
}
.ogc-result .thumbnail p {
    font-size: 12px;
    display: block; /* Fallback for non-webkit */
  display: -webkit-box;
  max-width: 400px;
  height: 84; /* Fallback for non-webkit (12*1.4*5**/
  margin: 0 auto;  
  line-height: 1.4;
  -webkit-line-clamp: 5;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
}

.bl img {
    max-height: 80px;
}

.bl .thumbnail {
    background-color: #dcdada;
}
.bl.visible .thumbnail {
    background-color: #fff;
}
.bl .caption {
    text-align: center;
}

select#opt-style {    
    color: #fff;
}

#frm-lis-styles .caption {
    font-size: xx-small;
}

#frm-lis-styles input[type="text"] { 
    width: 100%;
    background: grey;
    color: white;
    font-size: x-small;
}

#query-parameters {
    display: none;
}

#query-parameters.visible {
    display: block;
}

#searchelasticsearch_options,  #searchlocalities_options{   
    display: none;
    padding-top: 20px;
    padding-bottom: 20px;
}

#fuse_options {
    display: none;
}

.checkbox.lg input[type=checkbox] {
    transform: scale(2);
    margin-left: -30px!important;
}

#themes-list .list-group-item.active, #themeLayers .list-group-item.active {
    color: #31708f;
    background-color: #d9edf7;
    border-color: #bce8f1;
}


#csw-results {
    padding-top: 20px;
}

.themes-list-item .btn-group, layers-list-item .btn-group{
    margin-top: -3px;
    margin-right: -8px;
}

.themes-list-item .label-info {    
    margin-left: 3px;
}



</style>
<body>   
    <nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">GéoBretagne mviewer studio - version beta 1</a>
    </div>    
    <ul class="nav navbar-nav navbar-right">
      <li><a role="button" data-toggle="modal" data-target="#mod-importfile" href="#"><span role="button" class="glyphicon glyphicon-import"></span>Charger</a></li>
      <li><a role="button" onclick="saveApplicationParameters(false);" href="#"><span class="glyphicon glyphicon-download"></span>Sauvegarder</a></li>
      <li><a role="button" onclick="saveApplicationParameters(true);" href="#"><span class="glyphicon glyphicon-globe"></span>Prévisualiser</a></li>
    </ul>
  </div>
</nav>
    <div class="container">
        <div id="content">
            <ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
                <li class="active"><a href="#application-config" data-toggle="tab">Application</a></li>
                <li><a href="#themes-config" data-toggle="tab">Thématiques & données</a></li>
                <li><a href="#backgroundlayers-config" data-toggle="tab">Couches de fond</a></li>
                <li><a href="#search-config" data-toggle="tab">Recherche</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="application-config">
                   
                    <form class="form-horizontal">
                    <h1>Paramétrage de l'application</h1>      
                        <fieldset>

                        <!-- MAp -->
                                        
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="map">Cadrage initial</label>  
                          <div class="col-md-4">
                              <div id="map" class="map"></div>
                          </div>
                        </div> 
                       
                         <!-- Title-->
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="opt-title">Titre de l'application</label>  
                          <div class="col-md-4">
                            <input id="opt-title" name="textinput" type="text" placeholder="Kartenn" class="form-control input-md">  
                          </div>
                        </div>

                                                
                        <!-- logo-->
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="opt-logo">URL du Logo</label>  
                          <div class="col-md-4">
                            <input id="opt-logo" name="textinput" type="text" class="form-control input-md checkedurl" placeholder="https://geobretagne.fr/pub/logo/region-bretagne.jpg">  
                          </div>
                        </div>

                       <!-- help-->
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="opt-help">Fichier d'aide (format html)</label>  
                          <div class="col-md-4">
                            <input id="opt-help" name="textinput" type="text" class="form-control input-md checkedurl" placeholder="Ex: mviewer_help.html">  
                          </div>                          
                        </div>
                                                                        
                        <!--style-->
                        <div class="form-group">
                            <label class="control-label col-md-4" for="frm-style">Style</label> 
                                <div class="col-md-4">
                                <select id="opt-style" name="style" class="form-control default"  onchange="updateTheme(this);">                                    
                                    <option class="alizarin" value="css/themes/alizarin.css">alizarin</option>
                                    <option class="blue" value="css/themes/blue.css">blue</option>
                                    <option class="default" selected value="css/themes/default.css">default</option>
                                    <option class="nephritis" value="css/themes/nephritis.css">nephritis</option>
                                    <option class="ripe_lemon" value="css/themes/ripe_lemon.css">ripe_lemon</option>
                                    <option class="amethyst" value="css/themes/amethyst.css">amethyst</option>
                                    <option class="carrot" value="css/themes/carrot.css">carrot</option>
                                    <option class="green" value="css/themes/green.css">green</option>
                                    <option class="peter_river" value="css/themes/peter_river.css">peter_river</option>
                                    <option class="black" value="css/themes/black.css">black</option>
                                    <option class="chambray" value="css/themes/chambray.css">chambray</option>
                                    <option class="green_sea" value="css/themes/green_sea.css">green_sea</option>
                                    <option class="pink" value="css/themes/pink.css">pink</option>
                                    <option class="wet_asphalt" value="css/themes/wet_asphalt.css">wet_asphalt</option>
                                </select>
                            </div>
                      </div>
                     
                        <div class="form-group">
                          <label class="col-md-4 control-label" for="checkboxes">options</label>
                          <div class="col-md-4">
                          <div class="checkbox">
                            <label for="opt-measuretools">
                              <input type="checkbox" name="checkboxes" id="opt-measuretools">
                              Outils de mesures
                            </label>
                            </div>
                          
                          <div class="checkbox">
                            <label for="opt-exportpng">
                              <input type="checkbox" name="checkboxes" id="opt-exportpng">
                              Export de la carte au format png
                            </label>
                          </div>
                          
                          <div class="checkbox">
                            <label for="opt-showhelp">
                              <input type="checkbox" name="checkboxes" id="opt-showhelp">
                              Afficher l'aide au démarrage
                            </label>
                          </div>
                          
                          <div class="checkbox">
                            <label for="opt-coordinates">
                              <input type="checkbox" name="checkboxes" id="opt-coordinates">
                              Affichage des coordonnées au click
                            </label>
                          </div>                          
                          <div class="checkbox">
                            <label for="opt-togglealllayersfromtheme">
                              <input type="checkbox" name="checkboxes" id="opt-togglealllayersfromtheme">
                              Afficher/masquer toutes les données d'une thématique en un clic.
                            </label>
                          </div>
                          </div>
                        </div>                        
                    

                        </fieldset>
                    </form>
                </div>
                <div class="tab-pane" id="themes-config">
                    <h1>Thématiques et données</h1>
                    <div class="well"><h4>Sélection, paramétrage et organisation des données</h4>
                        <p>Dans cette section, créer une ou plusieurs thématiques que vous peuplerez avec des données provenant de différentes plateformes</p>
                    </div>
                                
                    <div class="row">                              
                        <div class="col-md-4">
                              <!-- List with handle -->                              
                              <div class="panel panel-default">
                                  <div class="panel-heading">Panneau des thématiques</div>
                                  <div class="panel-body">
                                    <div id="themes-list" class="list-group">                              
                                    </div>
                                    <div class="pull-right">
                                     <button id="btn-addTheme" class="btn btn-lg btn-primary" onclick="addTheme('Nouvelle thématique', true, createId('theme'));">
                                        <span class="glyphicon glyphicon-plus" aria-hidden="true"> </span> Ajouter une thématique
                                     </button>
                                     </div>
                                  </div>
                                  <div class="panel-footer">
                                    <div class="checkbox">
                                        <label for="opt-mini">
                                          <input type="checkbox" name="checkboxes" id="opt-mini">
                                          Option d'affichage : réduire le panneau des thématiques au démarrage
                                        </label>
                                      </div> 
                                  </div>
                                </div>
                             
                     </div>                   
                     <div class="col-md-4">                   
                        <div id="panel-theme" class="panel panel-info" style="display: none;">
                              <div class="panel-heading">
                                <h3 class="panel-title">Paramétrage de la Thématique sélectionnée</h3>
                              </div>
                              <div class="panel-body" id="theme-edit" data-themeid="">
                                <div class="input-group">
                                  <span class="input-group-addon">Nom</span>
                                  <input type="text" id="theme-edit-title" class="form-control" placeholder="Titre" aria-describedby="basic-addon1">
                                </div>
                                <div class="checkbox">
                                    <label for="theme-edit-collapsed">
                                      <input type="checkbox" name="checkboxes" id="theme-edit-collapsed" value="0">
                                      Déroulée par défaut
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="theme-edit-icon">Icone</label> 
                                    
                                        <select id="theme-edit-icon" name="icon" class="form-control">
                                        </select>
                                    
                              </div>
                                </br>
                                <!-- List with handle -->
                              <div id="themeLayers" class="list-group">                                
                              </div>
                              <div class="row">
                                  <div class="col-md-12">
                                      <div class="pull-right">
                                      <button id="btn-addLayer" class="btn btn-lg btn-primary" onclick="addLayer('Nouvelle couche');">
                                            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Ajouter des données
                                      </button>
                                      </div>
                                  </div>
                              </div>
                              </div>
                               <div class="panel-footer">
                                  <div class="row">
                                  <div class="col-md-12">
                                      <button id="btn-saveTheme" class="btn btn-sm btn-success" onclick="saveTheme();">
                                            <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Enregistrer la thématique
                                      </button>
                                      <div class="pull-right">
                                        <button class="btn btn-sm btn-default" onclick="$('#panel-theme').hide();">
                                            <span class="glyphicon glyphicon-remove"></span>Fermer
                                        </button>
                                      </div>
                                   </div>
                                   </div>
                              </div>                           
                        </div>
                   
                   </div>
                
            </div>
                
        </div>
                <div class="tab-pane" id="backgroundlayers-config">
                    <div class="row">                    
                        <div class="col-sm-6 col-md-6">
                            <h1>Couches de fond</h1>
                        </div>
                        <div class="col-sm-3 col-md-3">
                            <div class="form-group">
                                <label class="control-label" for="frm-bl-mode">Mode d'affichage</label> 
                                <select id="frm-bl-mode" name="bl-mode" class="form-control">                                    
                                    <option value="default">normal</option>
                                     <option value="gallery">gallerie</option>                               
                                </select>
                            </div>
                         </div>
                         <div class="col-sm-3 col-md-3">
                             <div class="form-group">
                                    <label class="control-label" for="frm-bl-mode">Fond affiché au démarrage</label> 
                                    <select id="frm-bl-visible" name="bl-visible" class="form-control" onchange="mv.changeVisibleBaseLayer(this.value)" ></select>
                             </div>
                          </div>
                    </div>
                    <div id="frm-bl"></div>                    
                </div>
                
                
                <div class="tab-pane" id="search-config">
                        <h1>Paramètres de recherche</h1>
                        
                        <div class="well well-lg">
                            <p>La recherche peut être activée si la couche est de type geojson.
                            Cette fonctionnalité est également activable pour les couches de type WMS à la condition que les entités qui composent cette couche soient également indexées dans Elasticsearch.</p>
                        </div>
                        <div class="well well-lg">
                            <div class="checkbox lg">
                                    <label for="opt-searchfeatures" >
                                      <input type="checkbox" id="opt-searchfeatures" value="0" >
                                      Activer la recherche d'entités
                                    </label>
                              </div> 
                        </div>
                        
                <div class="panel panel-default">
                <div class="panel-heading"> <h3 class="panel-title">Recherche d'adresses</h3> </div>
                        <div class="panel-body">
                                  <div class="form-group">
                                        <label class="control-label col-md-4" for="frm-searchlocalities">Service utilisé</label>                               
                                                <select id="frm-searchlocalities" name="searchlocalities" class="form-control" onchange="mv.changeSearchLocalities(this.value)" style="width:auto;">
                                                    <option value="false">Non utilisé</option>
                                                    <option value="ban">Base adresse Nationale</option>
                                                    <option value="geoportail">Géoportail</option>      
                                                </select>

                                  </div>
                                  
                             <form id="searchlocalities_options" class="form-horizontal">
                                                <div class="form-group">
                                                  <label class="col-md-4 control-label" for="opt-searchlocalities-url">URL</label>  
                                                  <div class="col-md-4">
                                                    <input id="opt-searchlocalities-url" type="text" placeholder="Url" class="form-control input-md">  
                                                  </div>
                                                </div>
                                               
                                                <div class="form-group">
                                                  <label class="col-md-4 control-label" for="opt-searchlocalities-attribution">Attribution</label>  
                                                  <div class="col-md-4">
                                                    <input id="opt-searchlocalities-attribution" type="text" placeholder="Attribution du service" class="form-control input-md">  
                                                  </div>
                                                </div>                        
                                    </form>      
                             </div>
                 </div>           
                        
               <div class="panel panel-default">
               <div class="panel-heading"> <h3 class="panel-title">Elasticsearch</h3> </div>
                <div class="panel-body">
                    <div class="form-group">
                            <label class="control-label col-md-4" for="frm-globalsearch">Options</label>
                                <select id="frm-globalsearch" name="globalsearch" class="form-control" onchange="mv.changeGlobalSearch(this.value)" style="width:auto;">
                                    <option value="false">Non utilisé</option>
                                    <option value="elasticsearch">Activé</option>                                     
                                </select>
                      </div>
                                         
                      <form  id="searchelasticsearch_options" class="form-horizontal">
                           
                            <div class="form-group">
                              <label class="col-md-4 control-label" for="opt-elasticsearch-url">URL Elasticsearch</label>  
                              <div class="col-md-4">
                                <input id="opt-elasticsearch-url" type="text" placeholder="Url Elasticsearch" class="form-control input-md">  
                              </div>
                            </div>
                           
                            <div class="form-group">
                              <label class="col-md-4 control-label" for="opt-elasticsearch-geometryfield">geometryfield</label>  
                              <div class="col-md-4">
                                <input id="opt-elasticsearch-geometryfield" type="text" placeholder="geometryfield" class="form-control input-md">  
                              </div>
                            </div>
                            
                            <div class="form-group">
                              <label class="col-md-4 control-label" for="opt-elasticsearch-linkid">linkid</label>  
                              <div class="col-md-4">
                                <input id="opt-elasticsearch-linkid" type="text" placeholder="linkid" class="form-control input-md">  
                              </div>
                            </div>
                           
                            <div class="form-group">
                              <label class="col-md-4 control-label" for="opt-elasticsearch-doctypes">doctypes</label>  
                              <div class="col-md-4">
                                <input id="opt-elasticsearch-doctypes" type="text" placeholder="doctypes" class="form-control input-md">  
                              </div>
                            </div>
                            
                            <div class="form-group">
                                    <label class="control-label col-md-4" for="opt-elasticsearch-querymode">Mode</label>
                                        <select id="opt-elasticsearch-querymode"  class="form-control" style="width:auto;" onchange="">
                                            <option value="match">match</option>
                                            <option value="term">term</option>
                                            <option value="phrase">phrase</option>                               
                                        </select>
                             </div>
                             
                              <div class="checkbox">
                                    <label for="opt-elasticsearch-bbox" >
                                      <input type="checkbox" id="opt-elasticsearch-bbox" value="0" >
                                      Rechercher dans l'emprise de la carte
                                    </label>
                              </div> 
                            
                             <div class="form-group">
                                    <label class="control-label col-md-4" for="opt-elasticsearch-version">Version</label>
                                        <select id="opt-elasticsearch-version"  class="form-control" style="width:auto;" onchange="">
                                            <option value="current">current</option>
                                            <option value="1.4">1.4</option>                                                            
                                        </select>
                             </div>
                          
                            
                      </form> 
                
                 </div>

</div>                      

                
            </div> <!-- tab-content-->
        </div>
        
          <!-- Modal file import-->
          <div class="modal fade" id="mod-importfile" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Importer un fichier de configuration</h4>
                </div>
                <div class="modal-body">
                                <div class="alert alert-info">
                                    <input type="file" name="filebutton" style="visibility:hidden;" id="filebutton" />
                                    <label>Choisissez un fichier</label>
                                    <div class="input-append">                                        
                                        <input type="text" id="subfile" class="input-xlarge">
                                        <a class="btn btn-primary btn-sm" onclick="$('#filebutton').click();">Parcourir</a>
                                    </div>
                               </div>                               
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                </div>
              </div>
            </div>
          </div>
          
          
           <!-- Modal layer options-->
          <div class="modal fade" id="mod-layerOptions" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>                  
                  <h4 class="modal-title">Edition de couche</h4>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" role="tablist" id="layer_sections_menu">    
                        <li role="presentation" class="active"><a href="#layer_conf1"  role="tab" data-toggle="tab">Base</a></li>
                        <li role="presentation" ><a href="#layer_conf2"  role="tab" data-toggle="tab">Fiche</a></li>
                        <li role="presentation" ><a href="#layer_conf3"  role="tab" data-toggle="tab">Affichage</a></li>
                        <li role="presentation" ><a href="#layer_conf4"  role="tab" data-toggle="tab">Filtre</a></li>
                        <li role="presentation" ><a href="#layer_conf5"  role="tab" data-toggle="tab">Liste de choix</a></li>
                        <li role="presentation" ><a href="#layer_conf6"  role="tab" data-toggle="tab">Recherche</a></li>
                    </ul>
                    <div class="tab-content" id="layer_sections">
                    <div role="tabpanel" class="tab-pane active" id="layer_conf1">
                   <form>
                      <div class="form-group">
                        <label for="frm-layer-title">Nom</label>
                        <input type="text" class="form-control" id="frm-name" placeholder="nom de la couche">
                      </div>
                      <!--<div class="form-group">
                        <label for="frm-type">Type</label>
                        <input type="text" class="form-control" id="frm-type" placeholder="type">
                      </div>-->
                      <div class="form-group">
                            <label class="control-label" for="frm-type">Type</label>
                                <select id="frm-type" name="type" class="form-control" onchange="mv.changeLayerType(this.value);">                                    
                                    <option value="wms">wms</option>
                                    <option value="geojson">geojson</option>
                                    <option value="kml">kml</option>
                                    <option value="customlayer">customlayer</option>
                                </select>                            
                      </div>
                      <div class="form-group">
                        <label for="frm-layerid">id</label>
                        <input type="text" class="form-control" id="frm-layerid" placeholder="id">
                      </div>
                       <div class="form-group">
                        <label for="frm-url">url</label>
                        <input type="text" class="form-control checkedurl" id="frm-url" placeholder="url">
                      </div>
                       <div class="form-group">
                        <label for="frm-attribution">Attributions</label>
                        <input type="text" class="form-control" id="frm-attribution" placeholder="Attribution">
                      </div>
                      <div class="form-group">
                        <label for="frm-metadata">URL fiche de métadonnées (html)</label>
                        <input type="text" class="form-control checkedurl" id="frm-metadata" placeholder="metadata">
                      </div>
                       <div class="form-group">
                        <label for="frm-metadata-csw">URL fiche de métadonnées (xml)</label>
                        <input type="text" class="form-control checkedurl" id="frm-metadata-csw" placeholder="metadata-csw">
                      </div>
                      <div class="form-group">
                          <div class="checkbox">
                            <label>
                              <input id="frm-secure" type="checkbox"> Donnée protégée
                            </label>
                          </div>
                      </div>   
                 </form>
               </div>
               <div role="tabpanel" class="tab-pane" id="layer_conf2">
                  <form>
                     <div class="row">
                        <div class="col-md-6">
                    <div class="form-group">
                          <div class="checkbox">
                            <label>
                              <input id="frm-queryable" type="checkbox">interrogeable
                            </label>
                          </div>
                      </div>
                      </div>
                      <div class="col-md-6">
                          <div class="form-group">
                                <label class="control-label" for="frm-infopanel">Position fiche info</label>
                                    <select id="frm-infopanel" name="infoformat" class="form-control" >                                    
                                        <option value="right-panel">Panneau de droite</option>
                                        <option value="bottom-panel">Panneau du bas</option>                               
                                    </select>
                                
                          </div>
                          </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                                <label class="control-label" for="frm-infoformat">Format de la fiche d'information</label>
                                    <select id="frm-infoformat" name="infoformat" class="form-control" onchange="mv.showHideQueryParameters(this.value);">                                    
                                        <option value="text/html">standard</option>
                                        <option value="application/vnd.ogc.gml">personnalisé</option>                               
                                    </select>
                                
                          </div>
                          </div>
                          <div class="col-md-6">
                          <div class="form-group">
                            <label for="frm-featurecount">Limitation du nombre de réponses</label>
                            <input type="number" class="form-control" id="frm-featurecount" placeholder="Nombre max d'entités retournées" step="1" min="1" max="50" value="5">
                          </div>
                          </div>
                      </div>
                      <div id="query-parameters">
                             <div class="form-group">
                                  <div class="checkbox">
                                    <label>
                                      <input id="frm-template" type="checkbox">Utliser un template
                                    </label>
                                  </div>
                                    <label for="frm-template-url">URL template</label>
                                    <input type="text" class="form-control checkedurl" id="frm-template-url" placeholder="URL template"/>
                              </div>
                            <div class="form-group">
                                <label class="control-label" for="frm-fields">Champs</label> 
                                <div id="frm-lis-fields">                               
                                </div >
                            </div>
                            
                      </div>

                  </form>
                 </div>
                 
                 
                 <div role="tabpanel" class="tab-pane" id="layer_conf3">
                  <form>
                    
                      <div class="form-group">                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                          <div class="checkbox">
                                            <label>
                                              <input id="frm-tiled" type="checkbox"> Couche tuilée
                                            </label>
                                          </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                    <div class="form-group">
                                      <div class="checkbox">
                                        <label>
                                          <input id="frm-visible" type="checkbox"> Visible au démarrage
                                        </label>
                                      </div>
                                    </div>
                                    </div>                                    
                             </div>
                                    <label for="frm-sld">SLD externe</label>
                                    <input type="text" class="form-control checkedurl" id="frm-sld" placeholder="URL SLD externe"/>
                                    
                                    <label for="frm-legendurl">Légende statique</label>
                                    <input type="text" class="form-control checkedurl" id="frm-legendurl" placeholder="URL vers Image légende"/>
                                     <div class="row">
                                        <div class="col-md-4">
                                        <div class="form-group" lang="en-US">
                                            <label for="frm-opacity">Opacité</label>
                                            <input type="number" class="form-control" id="frm-opacity" placeholder="Opacité (0 à 1)" step="0.1" min="0.1" max="1.0" value="1">
                                        </div>
                                        </div>
                                        <div class="col-md-4">
                                             <label for="frm-scalemin">Echelle mini</label>
                                            <input type="number" class="form-control" id="frm-scalemin" placeholder="Echelle mini"/>
                                        </div>
                                         <div class="col-md-4">
                                    <label for="frm-scalemax">Echelle maxi</label>
                                    <input type="number" class="form-control" id="frm-scalemax" placeholder="Echelle maxi"/>
                                    </div>
                                 </div>
                                 
                                 <label class="control-label" for="frm-styles">Styles</label> 
                                    <div class="row" id="frm-lis-styles">                               
                                 </div >
                      </div>
                  </form>
                 </div>
                 
                  <div role="tabpanel" class="tab-pane" id="layer_conf4">
                            <div class="well">Filtre côté serveur</div>
                            <form>
                                <div class="row">
                                    <div class="col-md-12">
                                    <label for="frm-filter">filtre actif</label>
                                    </div>
                                </div>
                                <div class="row">
                                <div class="col-md-8">
                                <div class="form-group">                                    
                                    <input type="textarea" class="form-control" id="frm-filter" placeholder="filtre cql">
                                 </div>
                                 </div>
                                 <div class="col-md-4">
                                 <button type="button" onclick="$('#filter_wizard').toggle();" class="btn btn-primary">Créer un filtre</button>
                                 </div>
                                 </div>
                                 <div id="filter_wizard" style="display:none;">
                                 <!-- Nav tabs -->
                                  <ul class="nav nav-tabs" role="tablist">
                                    <li role="presentation" class="active" ><a href="#attribute_filter" aria-controls="attribute_filter" role="tab" data-toggle="tab">Filtre attributaire</a></li>
                                    <li role="presentation" ><a href="#geo_filter" aria-controls="geo_filter" role="tab" data-toggle="tab">Filtre géographique</a></li> 
                                  </ul>
                                  <!-- Tab panes -->
                                  <div class="tab-content">
                                        <div role="tabpanel" class="tab-pane active" id="attribute_filter">                                            
                                                <div class="form-group">
                                                    <label class="control-label" >Champs</label>                                                    
                                                        <select id="attribute_filter_fields" name="fields" class="form-control" onchange="extractFeatures(this.value, 'source')";>
                                                        </select>
                                                  </div>
                                                  <div class="form-group">
                                                    <label class="control-label" >Opérateur</label>                                                    
                                                        <select id="attribute_filter_operators" name="operators" class="form-control">
                                                            <option value="=">=</option>
                                                            <option value="IN">IN</option>
                                                            <option value="NOT IN">NOT IN</option>
                                                        </select>
                                                   </div>
                                                   <div class="row">
                                                        <div class="col-md-8">
                                                           <label class="control-label" >valeurs sélectionnées</label>
                                                           <div class="form-group">                                                        
                                                                <input type="text" value="" data-role="tagsinput" id="source_fields_tags" class="form-control"/>
                                                           </div>
                                                        </div>                                                        
                                                        <div class="col-md-4" style="padding-top: 25px;">
                                                                <button type="button" onclick="mv.saveSourceAttributeFilter()" class="btn btn-success">Appliquer le filtre</button>
                                                        </div>
                                                   </div>
                                                             
                                        </div>
                                                                   
                                        <div role="tabpanel" class="tab-pane" id="geo_filter">
                                            <div id="map_filter" class="map" ></div>
                                        </div>
                                  </div> 
                                </div>
                            </form>
                        </div>
                 
                  <div role="tabpanel" class="tab-pane" id="layer_conf5">
                    <div class="well">Filtre côté client</div>
                  <form>
                    
                      <div class="form-group">
                                <div class="form-group">
                                    <label for="frm-attributelabel">Label</label>
                                    <input type="textarea" class="form-control" id="frm-attributelabel" placeholder="Texte à afficher">
                                 </div>                                
                                 
                                <div class="form-group">
                                    <label class="control-label" >Champs</label>                                                    
                                        <select id="opt-attributefield" name="fields" class="form-control" onchange="extractFeatures(this.value,'control')";>
                                        </select>
                                        <label class="control-label" >valeurs sélectionnées</label>
                                           <div class="form-group">                                                        
                                                <input type="text" value="" data-role="tagsinput" id="control_fields_tags" class="form-control"/>
                                           </div>                                       
                                </div>
                                                                
                      </div>

                  </form>
                 </div>
                 
                    <div role="tabpanel" class="tab-pane" id="layer_conf6">
                  <form>                    
                       <div class="form-group">
                          <div class="checkbox">
                            <label>
                              <input id="frm-searchable" type="checkbox"> Activer la recherche pour cette donnée
                            </label>
                          </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label" for="frm-searchengine" >Moteur de recherche</label>                                                    
                            <select id="frm-searchengine" class="form-control" onchange="mv.changeSearchEngine(this.value)" >
                                <option value="elasticsearch">elasticsearch</option>
                                <option value="fuse">fuse</option>
                            </select>
                       </div>
                       <div id="fuse_options">
                           <div class="form-group">
                                <label for="frm-fusesearchkeys">fusesearchkeys</label>
                                <input type="text" class="form-control" id="frm-fusesearchkeys" placeholder="fusesearchkeys">
                           </div>
                           
                           <div class="form-group">
                                <label for="frm-fusesearchkeys">fusesearchresult</label>
                                <input type="text" class="form-control" id="frm-fusesearchresult" placeholder="fusesearchresult">
                           </div>
                       </div>
                  </form>
                 </div>
                 
                 
                 </div>
                </div>
                <div class="modal-footer">
                  <button type="button" onclick="mv.saveLayerOptions()" class="btn btn-success">Enregistrer</button>
                  <button type="button" onclick="mv.form2xml()" class="btn btn-info">Voir</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                </div>
              </div>
            </div>
          </div>
          
           <!-- Modal codeView-->
          <div class="modal fade" id="mod-codeview" role="dialog">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Configuration XML</h4>
                </div>
                <div class="modal-body">
                        <div class="row">
                            <pre></pre>
                          </div><!-- /.row -->
                        
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal featuresView-->
          <div class="modal fade" id="mod-featuresview" role="dialog">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Sélection de données</h4>
                </div>
                <div class="modal-body">
                        <div class="row">
                             <div class="col-md-6">
                                 <label class="control-label" >Valeurs</label>
                                 <div id="distinct_values" class="list-group"></div>
                            </div>
                          </div><!-- /.row -->
                        
                </div>

              </div>
            </div>
          </div>
          
           <!-- Modal new Layer-->
          <div class="modal fade" id="mod-layerNew" role="dialog">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Rechercher des données</h4>
                </div>
                <div class="modal-body">
                        <div class="row">
                             <div class="col-md-12">
                                <div class="input-group">
                                  <input type="text" id="input-ogc-filter" class="form-control" aria-label="..." placeholder="Rechercher...">
                                  <div class="input-group-btn">
                                    <button type="button" class="btn btn-warning dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Fournisseurs de données<span class="caret"></span></button>
                                    <ul class="dropdown-menu dropdown-menu-right" id="providers_list">
                                    </ul>
                                    <button type="button" class="btn btn-primary" onclick="mv.search()" >Rechercher</button>
                                  </div><!-- /btn-group -->
                                </div><!-- /input-group -->
                              </div><!-- /.col-lg-6 -->
                          </div><!-- /.row -->
                         <div class="row ogc-results" id="csw-results" style="display: none;"></div>
                         <div class="row ogc-results" id="wms-results" style="display: none;"></div>
                         <div class="row ogc-results" id="wfs-results" style="display: none;"></div>
                         </div>
                         <div class="modal-footer">
                          <div class="pull-left">
                            <div class="form form-inline">
                              <div class="form-group">
                                <input class="form-control custom-url" type="text" placeholder="URL du fournisseur..."> </input>
                                <select class="form-control"><option>csw</option><option>wms</option></select>
                                <input class="form-control custom-title" type="text" placeholder="Nom..."> </input>
                                <button type="button" class="btn btn-primary" onclick="addNewProvider(this);">Ajouter un fournisseur</button>
                              </div>
                             </div>
                          </div>
                          <button type="button" class="btn btn-success" onclick="mv.getConfLayers();">Sélectionner</button>                          
                          <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
                        </div>
                </div>
                
              </div>
            </div>
          </div>
        
        
        
    </div>
    <script>
        var _conf;
        $(document).ready(function(){
             $.ajax({
                    type: "GET",
                    url: "config.json",                                        
                    dataType: "json",
                    contentType: "application/json",
                    success: function (data) {
                        _conf = data.app_conf;
                        _conf.proxy = "../proxy/?url=";
                        mv.showBaseLayers(_conf.baselayers);                       
                        //Sélection par défaut des 2 1er baselayers
                        $("#frm-bl .bl input").slice(0,2).prop("checked",true).trigger('change');
                        $("#frm-bl-visible").val($("#frm-bl-visible option:not(:disabled)").first().val());
                        map2.getView().setCenter(_conf.map.center);
                        map2.getView().setZoom(_conf.map.zoom);
                        var csw_providers = [];
                        var wms_providers = [];
                        _conf.data_providers.csw.forEach(function(provider,id) {
                            var cls = "active";
                            if (id > 0) {
                                cls ="";
                            } 
                            csw_providers.push('<li class="'+cls+'"><a onclick="setActiveProvider(this);" data-providertype="csw" class="dropdown-toggle" data-provider="'+provider.url+'" data-metadata-app="'+provider.baseref+'" href="#">'+provider.title+'</a></li>');
                        });
                        $("#providers_list").append(csw_providers.join(" "));
                        $("#providers_list").append('<li role="separator" class="divider"></li>');
                         _conf.data_providers.wms.forEach(function(provider,id) {                            
                            wms_providers.push('<li><a onclick="setActiveProvider(this);" data-providertype="wms" data-provider="'+provider.url+'" href="#">'+provider.title+'</a></li>');
                        });
                        $("#providers_list").append(wms_providers.join(" "));
                        $("#providers_list").append('<li role="separator" class="divider"></li>');
                        newConfiguration();
                    },                
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert("Problème avec la récupération de la configuration");
                    }
             });
             $('#tabs').tab();
             $.get("img/icons/icons-fontawesome.html",function( data ) {
                $("#theme-edit-icon").append(data);
                $("#theme-edit-icon option").each(function(i, el) {
                    $(el).attr("value", $.trim($(el).text().split("[")[0]));
                });
             });
             
	  });
      //EPSG:2154
      proj4.defs("EPSG:2154","+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
        //Map      
      
      var map = new ol.Map({
                layers: [
                  new ol.layer.Tile({
                    source: new ol.source.OSM()
                  })
                ],
                target: 'map'                
      });
      
      var savedParameters;
      
      //Map_filter
      var draw;
      var source = new ol.source.Vector({wrapX: false});
      var vector = new ol.layer.Vector({
        source: source
      });
      var map2 = new ol.Map({
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          vector
        ],
        target: 'map_filter'
      });
      var config;
      
      var newConfiguration = function () {            
            ["opt-title", "opt-logo", "opt-help", "theme-edit-icon", "theme-edit-title"].forEach(function (param, id) {
                $("#"+param).val("");
            });
            ["opt-exportpng", "opt-measuretools", "theme-edit-collapsed", "opt-mini", "opt-showhelp", "opt-coordinates", "opt-togglealllayersfromtheme"].forEach(function (param, id) {
                $("#"+param).prop('checked', false);
            });            
            
            $("#opt-style").val("css/themes/default.css").trigger("change");
            $("#theme-edit-icon option").prop("selected", false);            
            $("#panel-theme").hide();
            
            map.getView().setCenter(_conf.map.center);
            map.getView().setZoom(_conf.map.zoom);
            config = {
                application: { title: "", logo: "" },
                themes: {},
                temp : { layers : {}}
            };
            //Store des parametres non gérés
            savedParameters = {"application":[]};
            $(".list-group-item").remove();           
      };
      
      
      var loadLayers = function (themeid) {
            var theme = config.themes[themeid];
            if (theme) {
                $.each(theme.layers, function (index, layer) {
                        addLayer(layer.title, layer.id);
                 });
            }
      };
      
      var sortableLayerList = Sortable.create(document.getElementById('themeLayers'), {
          handle: '.glyphicon-move',          
          animation: 150,
          ghostClass: 'ghost',          
          onEnd: function (evt) {                            
                sortLayers(evt.oldIndex, evt.newIndex);
            }
        });
        
       var deleteThemeItem = function (btn) {
            var el = $(btn).closest(".list-group-item")[0];            
            var themeid = $(el).attr("data-themeid");
            deleteTheme(themeid);
            el && el.parentNode.removeChild(el);
       };
        
       var deleteLayerItem = function (btn) {
            var el = $(btn).closest(".layers-list-item")[0];            
            deleteLayer(el.getAttribute('data-layerid'));            
            el && el.parentNode.removeChild(el);
       };
       
       var sortableThemeList = Sortable.create(document.getElementById('themes-list'), {
          handle: '.glyphicon-move',          
          animation: 150,
          ghostClass: 'ghost',          
          onEnd: function (evt) {
                sortThemes();
            }
        });
        
        sortThemes = function () {
            var orderedThemes = {};                
            $(".themes-list-item").each(function(i,item) {
                var id = $(this).attr("data-themeid");
                orderedThemes[id] = config.themes[id];
            });
            config.themes = orderedThemes;
        };
        
        sortLayers = function (fromIndex, toIndex) {
            var themeid = $("#themes-list .active").attr("data-themeid");
            var arr = config.themes[themeid].layers;
            var element = arr[fromIndex];
            arr.splice(fromIndex, 1);
            arr.splice(toIndex, 0, element);
        };
      
      $('input[type=file]').change(function () {
            loadApplicationParameters();
        });
        
              
     var addLayer = function (title, layerid) {
        // test if theme is saved
        if (!config.themes[$("#theme-edit").attr("data-themeid")]) {
            saveTheme();
        }
        var item = $("#themeLayers").append(['<div class="list-group-item layers-list-item" data-layerid="'+layerid+'">',
            '<span class="glyphicon glyphicon-move" aria-hidden="true"></span>', 
            '<div class="pull-right btn-group" role="group">',            
            '<button class="btn btn-sm btn-warning" onclick="editLayer(this);"><span class="layer-edit glyphicon glyphicon-pencil" title="Editer cette couche"></span></button>',
            '<button class="btn btn-sm btn-warning" onclick="deleteLayerItem(this);"><span class="layer-remove glyphicon glyphicon-remove" title="Supprimer"></span></button>',
            '</div>',
            '<span class="layer-name">'+title+'</span>',
            '</div>'].join(""));
            
         if (title === 'Nouvelle couche') {
            item.find(".layer-edit").last().click();
         }           
     };
     
     var editLayer = function (item) {        
        $("#themeLayers .list-group-item").removeClass("active");
        var element = $(item).parent().parent();
        element.addClass("active");        
        var title = element.find(".layer-name").text();
        var layerid = element.attr("data-layerid");        
        if (layerid != "undefined") {            
            $("#mod-layerOptions").modal();
            mv.showLayerOptions(element);            
        } else {
            $("#mod-layerNew").modal();
        }        
     };
     
     var addTheme = function (title, collapsed, themeid, icon) {
        if ($("#panel-theme").is(":visible")) {
            alert("Enregister d'abord votre thématique");
            return;
        }
        $("#themes-list").append(['<div class="list-group-item themes-list-item" data-theme="'+title+'" data-themeid="'+themeid+'" data-theme-collapsed="'+collapsed+'" data-theme-icon="'+icon+'">',
            '<span class="glyphicon glyphicon-move" aria-hidden="true"></span>',            
            '<div class="pull-right btn-group" role="group">',            
            '<button class="btn btn-sm btn-warning" onclick="editTheme(this);"><span class="theme-edit glyphicon glyphicon-pencil" title="Editer ce thème"></span></button>',
            '<button class="btn btn-sm btn-warning" onclick="deleteThemeItem(this);" ><span class="theme-remove glyphicon glyphicon-remove" title="Supprimer"></span></button>',
            '</div>',
            '<span class="theme-name">'+title+'</span><span class="label label-info">0</span></div>'].join(""));
            config.themes[themeid] = {
                title:title,
                id: themeid,
                icon: icon,
                collapsed: collapsed,
                layers: []
            };
            if (title === "Nouvelle thématique") {
                $(".themes-list-item[data-themeid='"+themeid+"'] .theme-edit").parent().trigger("click");
            }
     };
     
     var editTheme = function (item) {
        $("#themes-list .list-group-item").removeClass("active");
        $(item).parent().parent().addClass("active");
        var title = $(item).parent().parent().attr("data-theme");
        var themeid = $(item).parent().parent().attr("data-themeid");
        var collapsed = ($(item).parent().parent().attr("data-theme-collapsed")==="true")?false:true;
        var icon = $(item).parent().parent().attr("data-theme-icon");
        $("#panel-theme").show();
        $("#theme-edit-title").val(title);
        $("#theme-edit-collapsed").prop('checked', collapsed);
        $("#theme-edit").attr("data-themeid", themeid);
        $("#theme-edit-icon").val(icon);
        $("#theme-edit-icon option[value='"+icon+"']").prop("selected", true);
        if (icon === "undefined") {
                $("#theme-edit-icon option[value='caret-right']").prop("selected", true);
         }
        //Remove old layers entries
        $(".layers-list-item").remove();
        //Show layerslm
        loadLayers(themeid);
     };
     
     var saveTheme = function () {
        //get active item in left panel
        var theme = $("#themes-list .active");
        //get edited values (right panel)
        var title = $("#theme-edit-title").val();        
        var themeid = $("#theme-edit").attr("data-themeid");
        var collapsed = !$("#theme-edit-collapsed").prop('checked');
        var icon = $.trim($("#theme-edit-icon").val());
        //update values in left panel
        theme.attr("data-theme", title);      
        theme.attr("data-theme-collapsed", collapsed);
        theme.attr("data-theme-icon", icon);
        theme.find(".theme-name").text(title);
        var nb_layers = $("#themeLayers .list-group-item").length;
        theme.find(".label").text(nb_layers);
        //deactivate theme edition
        $("#themes-list .list-group-item").removeClass("active");
        $("#panel-theme").hide();
        
        //save theme locally
        config.themes[themeid].title = title;
        config.themes[themeid].id = themeid;
        config.themes[themeid].collapsed = collapsed;
        config.themes[themeid].icon = icon;
         
        
     };
     
     var deleteTheme = function (themeid) {
        $("#panel-theme").hide();
        delete config.themes[themeid];
     };
     
     var deleteLayer = function (layerid) {
        var themeid = $("#theme-edit").attr("data-themeid");
        var index = config.themes[themeid].layers.findIndex(function(l){return l.id === layerid});
        config.themes[themeid].layers.splice(index, 1);
     };
     
     var createId = function (obj) {
        var d = new Date();
        var df = d.getFullYear() + ("0"+(d.getMonth()+1)).slice(-2)+
            ("0" + d.getDate()).slice(-2) + ("0" + d.getHours()).slice(-2) + ("0" + d.getMinutes()).slice(-2) + ("0" + d.getSeconds()).slice(-2);
        return obj+'-' + df;
     };
     
     var createBaseLayerDef = function (bsl) {
         var parameters ="";
         $.each(bsl, function(param, value) {
            if (param === "attribution") {
                value = mv.escapeXml(value);
            }
            parameters += param+'="' + value +'" ';            
         });
         return parameters;
     };
        
      var saveApplicationParameters = function (option) {
         var padding = function (n) {
            return '\r\n' + " ".repeat(n);
         };
         var savedProxy = "";
         var olscompletion = "";
         var elasticsearch = "";
         var savedSearchparameters = "";
         var application = ['<application',
            'title="'+$("#opt-title").val()+'"',            
            'logo="'+$("#opt-logo").val()+'"',
            'help="'+$("#opt-help").val()+'"',            
            'style="'+$("#opt-style").val()+'"',  
            'exportpng="'+($('#opt-exportpng').prop('checked')=== true)+'"',            
            'showhelp="'+($('#opt-showhelp').prop('checked')=== true)+'"',
            'coordinates="'+($('#opt-coordinates').prop('checked')=== true)+'"',
            'measuretools="'+($('#opt-measuretools').prop('checked')=== true)+'"',
            'togglealllayersfromtheme="'+($('#opt-togglealllayersfromtheme').prop('checked')=== true)+'"'];
            
         savedParameters.application.forEach(function(parameter, id){
            $.each(parameter,function(prop,val) {
                console.log(prop,val)
                application.push(prop+'="'+val+'"');
            });
         });
         application = application.join(padding(4)) + '>'+padding(0)+'</application>';
         if ( savedParameters.proxy  ) {
            savedProxy = padding(0) + savedParameters.proxy;
         }
         var search_params = {"bbox":false, "localities": false, "features":false, "static":false};
         if ( $("#frm-searchlocalities").val() !="false"  ) {
            olscompletion = [padding(0) + '<olscompletion type="'+$("#frm-searchlocalities").val()+'"',
                'url="'+$("#opt-searchlocalities-url").val()+'"',
                'attribution="'+$("#opt-searchlocalities-attribution").val()+'" />'].join(" ");
                search_params.localities = true;
         }
         if ( $("#frm-globalsearch").val() === "elasticsearch" && $("#opt-elasticsearch-url").val() ) {
            elasticsearch = [padding(0) + '<elasticsearch url="'+$("#opt-elasticsearch-url").val()+'"',
                'geometryfield="'+$("#opt-elasticsearch-geometryfield").val()+'"',
                'linkid="'+$("#opt-elasticsearch-linkid").val()+'"',
                'doctypes="'+$("#opt-elasticsearch-doctypes").val()+'"',
                'mode="'+($("#opt-elasticsearch-mode").val() || 'match')+'"',
                'version="'+$("#opt-elasticsearch-version").val()+'" />'].join(" ");                
                if ($("#opt-elasticsearch-doctypes").val().length >=0) {
                    search_params.static = "true";
                }
                if ($("#opt-elasticsearch-bbox").prop("checked")) {
                    search_params.bbox = "true";
                } 
         }
        if  ( $("#opt-searchfeatures").prop("checked") ) {
            search_params.features = true;
        }        
         
         
         searchparameters = padding(0) + '<searchparameters bbox="'+search_params.bbox+'" localities="'+search_params.localities+'" features="'+search_params.features+'" static="'+search_params.static+'"/>';
         
         var center = map.getView().getCenter().join(",");
         var zoom = map.getView().getZoom();
         var mapoptions = padding(0) + '<mapoptions maxzoom="20" projection="EPSG:3857" center="'+center+'" zoom="'+zoom+'" />';
            
         var baseLayersMode = $("#frm-bl-mode").val();
         var visibleBaselayer = $("#frm-bl-visible").val();
         var baseLayers =   [padding(0) + '<baselayers style="'+baseLayersMode+'">'];
         $(".bl input:checked").each(function (i, b) {
            // set first bl visible           
            var baseLayer = _conf.baselayers[$(b).parent().parent().attr("data-layerid")];                        
            var definition = [
             '<baselayer visible="false" ',
             createBaseLayerDef(baseLayer),
             ' ></baselayer>'].join("");
            if (baseLayer.id === visibleBaselayer) {
                definition = definition.replace('visible="false"', 'visible="true"');
            }
            baseLayers.push(padding(4) + definition);
         });
         baseLayers.push(padding(0)+'</baselayers>');
         var themes = [ padding(0)+ '<themes mini="'+($('#opt-mini').prop('checked')=== true)+'">'];
         $.each(config.themes, function (i, t) {            
            var theme = [padding(4)+'<theme id="'+t.id+'" name="'+t.title+'" collapsed="'+t.collapsed+'" icon="'+t.icon+'">'];
            $(t.layers).each (function (i, l) {
                var layer = mv.writeLayerNode(l);
                theme.push(layer);
            });
            themes.push(theme.join(" "));
            themes.push(padding(4)+'</theme>');
         });
         themes.push(padding(0)+'</themes>');
                     
         var conf = ['<?xml version="1.0" encoding="UTF-8"?>\r\n<config>\r\n',
            application,
            mapoptions,
            savedProxy,
            olscompletion,
            elasticsearch,
            searchparameters,
            baseLayers.join(" "),
            themes.join(" "),
            padding(0)+ '</config>'];
         
         if (option) {         
                 $.ajax({
                  type: "POST",
                  url: _conf.upload_service,
                  data: conf.join(""),
                  dataType: 'json',
                  contentType: 'text/xml',
                  success: function( data ) {
                    if (data.success && data.filepath) {
                    console.log(data.filepath);
                    var url = _conf.mviewer_instance + '?config=' + _conf.conf_path_from_mviewer + data.filepath;
                    window.open(url,'_blank');
                    }
                  }
                });
          } else {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/xml;charset=utf-8,' +      encodeURI(conf.join("")));
            element.setAttribute('download', "config.xml");
            document.body.appendChild(element);
            element.click();            
            document.body.removeChild(element);
          }
        
      };
      
      var addgeoFilter = function () {
          var layername = $(".layers-list-item.active").attr("data-layerid");
          map2.updateSize();
          draw = new ol.interaction.Draw({
            source: source,
            type: "Polygon"
          });
          draw.on('drawend', function (e) {
            source.clear();
            var currentFeature = e.feature;//this is the feature fired the event
            var layer = config.temp.layers[layername];
            var projGeom = e.feature.getGeometry().clone().transform('EPSG:3857',layer.projection);
            var format = new ol.format.WKT();
            var wktRepresenation  = format.writeGeometry(projGeom);            
            $("#frm-filter").val('INTERSECTS('+layer.geometry+ ',' + wktRepresenation + ')');
            $("#filter_wizard").hide();
          });
          map2.addInteraction(draw);        
      };
      
      var extractFeatures = function (fld, option) {        
        var layerid = $(".layers-list-item.active").attr("data-layerid");
        var layer = config.temp.layers[layerid];        
        ogc.getFeatures(layer.wfs_url,layerid,fld, option);
        if (option === 'control') {
            $("#frm-attributelabel").val(fld);
        }
      };
      
      var  loadApplicationParameters = function () {
        var file = document.getElementById("filebutton").files[0];
        if (file) {
            var reader = new FileReader();
            reader.readAsText(file, "UTF-8");
            reader.onload = function (evt) {
                newConfiguration();
                var xml = $.parseXML(evt.target.result);
                console.log(xml);
                var proxy = $(xml).find("proxy");
                var olscompletion = $(xml).find("olscompletion");
                if (olscompletion && olscompletion.attr("type")) {
                    $("#frm-searchlocalities").val(olscompletion.attr("type")).trigger("change");
                }
                if (olscompletion && olscompletion.attr("url")) {
                    $("#opt-searchlocalities-url").val(olscompletion.attr("url"));
                }
                if (olscompletion && olscompletion.attr("attribution")) {
                    $("#opt-searchlocalities-attribution").val(olscompletion.attr("attribution"));
                }
                var elasticsearch = $(xml).find("elasticsearch");
                if (elasticsearch && elasticsearch.attr("url")) {
                     $("#frm-globalsearch").val("elasticsearch").trigger("change");
                     ["url", "geometryfield", "linkid", "doctype", "mode", "version"].forEach(function(param,id) {
                          $("#opt-elasticsearch-"+param).val(elasticsearch.attr(param));
                      });
                }
                var searchparameters = $(xml).find("searchparameters"); 
                if ( searchparameters && searchparameters.attr("bbox") ) {
                        $("#opt-elasticsearch-bbox").prop("checked", (searchparameters.attr("bbox") === "true"));
                }
                if ( searchparameters && searchparameters.attr("features") ) {
                        $("#opt-searchfeatures").prop("checked", (searchparameters.attr("features") === "true"));
                }
                
             
                [proxy].forEach(function(param,id) {
                    // this parameters are not yet supported but must be saved for later
                    if (param.length>0) {
                        savedParameters[param.selector] = param[0].outerHTML;
                    }
                });
                //Application                
                var application = $(xml).find("application");                
                ["stats", "statsurl"].forEach(function(param,id) {
                   // this parameters are not yet supported but must be saved for later
                   var parameter = new Object();
                   if (application.attr(param)) {
                       parameter[param] = application.attr(param);
                       savedParameters.application.push(parameter);
                   }
                });                
                ["title", "logo", "help", "style"].forEach(function(value,id) {
                    if (application.attr(value)) {
                        $("#opt-" + value).val(application.attr(value)).trigger("change");
                    }
                    if (value === "style") {
                        updateTheme($("#opt-" + value)[0]);
                    }
                }); 
                
                ["exportpng", "measuretools", "showhelp", "coordinates", "togglealllayersfromtheme"].forEach(function(value,id) {
                    if (application.attr(value) && application.attr(value) === "true") {
                        $("#opt-" + value).prop("checked", true);
                    }
                });
                //Mapoptions
                var mapoptions = $(xml).find("mapoptions");                
                ["projection", "maxzoom"].forEach(function(value,id) {
                    if (mapoptions.attr(value)) {
                        $("#opt-" + value).val(mapoptions.attr(value));
                    }
                });               
                map.getView().setCenter(mapoptions.attr("center").split(",").map(Number));
                map.getView().setZoom(parseInt(mapoptions.attr("zoom")));
                //BaseLayers
                var baseLayersMode = $(xml).find("baselayers").attr("mode") || "default";                
                $("#frm-bl-mode option[value='"+baseLayersMode+"']").prop("selected", true);
                var baselayers = $(xml).find("baselayer");
                //Reinitialisation
                $(".bl input").prop("checked",false);
                $("#frm-bl-visible option").attr('disabled', 'disabled');
                baselayers.each(function(id, bl) {
                    var id = $(bl).attr("id");
                    $("#frm-bl .bl[data-layerid='"+id+"'] input").prop("checked",true).trigger('change');
                });
                var visibleBaselayer = $(xml).find('baselayer[visible="true"]').attr("id");
                $("#frm-bl-visible").val(visibleBaselayer).trigger('change');
                //tHEMES & layers
                var themePanel =  $(xml).find("themes");                
                if (themePanel.attr("mini") === "true") {
                    $('#opt-mini').prop('checked', true);
                }
                var themes = $(xml).find("theme");
                themes.each(function(id, th) {                    
                    addTheme ($(th).attr("name"), ($(th).attr("collapsed") || true), $(th).attr("id"), $(th).attr("icon"));
                    var layers = $(th).find("layer");
                    var counter = 0;
                    layers.each(function(id, l) {
                        counter +=1;
                        var layer = {
                            id: $(l).attr("id"),
                            type: $(l).attr("type") || "wms",
                            tiled: ($(l).attr("tiled") === "true"),
                            scalemin: $(l).attr("scalemin"),
                            scalemax: $(l).attr("scalemax"),
                            title: $(l).attr("name"),
                            name: $(l).attr("name"),
                            url: mv.escapeXml($(l).attr("url")),
                            queryable: ($(l).attr("queryable") === "true"),
                            featurecount: $(l).attr("featurecount"),
                            infopanel: $(l).attr("infopanel") || 'right-panel',
                            searchable: ($(l).attr("searchable") === "true"),
                            searchengine:$(l).attr("searchengine"),
                            fusesearchkeys:$(l).attr("fusesearchkeys"),
                            fusesearchresult:$(l).attr("fusesearchresult"),
                            secure: ($(l).attr("secure") === "true"),
                            infoformat: $(l).attr("infoformat"),
                            metadata: $(l).attr("metadata"),
                            "metadata-csw": mv.escapeXml($(l).attr("metadata-csw")),
                            attribution: $(l).attr("attribution"),
                            filter: $(l).attr("filter"),
                            visible: ($(l).attr("visible") === "true"),
                            opacity: $(l).attr("opacity"),
                            template: $(l).find("template").text(),
                            usetemplate: ($(l).find("template") && $(l).find("template").text().length > 3 || ($(l).find("template").attr("url") && ($(l).find("template").attr("url").length>1))),
                            templateurl : false,
                            fields:  $(l).attr("fields"),
                            fieldsoptions : false,
                            aliases:  $(l).attr("aliases"),
                            style:  $(l).attr("style"),
                            stylesalias:  $(l).attr("stylesalias"),
                            sld: $(l).attr("sld"),
                            legendurl: $(l).attr("legendurl"),
                            attributefilter: ($(l).attr("attributefilter") === "true")
                        };
                        if (layer.attributefilter) {
                            layer.attributefield = $(l).attr("attributefield");
                            layer.attributelabel = $(l).attr("attributelabel");
                            layer.attributevalues = $(l).attr("attributevalues");
                        }
                        if (layer.usetemplate === true && $(l).find("template").attr("url")) {
                            layer.templateurl = $(l).find("template").attr("url");
                            console.log(layer.templateurl);                            
                        }
                        $("#frm-template").prop("checked", (layer.usetemplate)); 
                        if (layer.fields && layer.aliases) {
                            layer.fieldsoptions = {};            
                            $(layer.fields.split(",")).each(function (index, fld) {
                                var type = "text";                                
                                var alias = layer.aliases.split(",")[index];                
                                layer.fieldsoptions[fld] = {"name": fld, "alias": alias, "type": type};                
                            });
                        }
                        config.themes[$(th).attr("id")].layers.push(layer);
                        
                    });
                    $(".themes-list-item[data-themeid='"+$(th).attr("id")+"'] .label").text(counter);
                });
                
                $("#mod-importfile").modal("hide");
            }
            reader.onerror = function (evt) {
                alert("error reading file");
            }
        }
      };
      
      /*var search = function () {
        mv.resetSearch();
        ogc.cswSearch();
      };*/
      
      var updateTheme = function (el) {
        console.log(el);
        var cls = $("#"+el.id+" option[value='"+el.value+"']").text();
        $(el).removeClass().addClass("form-control " + cls);
      
      };
      
      var setActiveProvider = function (el) {      
         $(el).parent().parent().find(".active").removeClass("active");         
         $(el).parent().addClass("active");
     };
      
      var addNewProvider = function (el) {
        var frm = $(el).closest("div");
        var url = frm.find("input.custom-url").val();
        var type = frm.find("select").val();
        var title = frm.find("input.custom-title").val();
        $("#providers_list").append('<li><a onclick="setActiveProvider(this);" data-providertype="'+type+'" data-provider="'+url+'" href="#">'+title+'</a></li>').trigger("click");
        frm.find("input.custom-url").val("");
        frm.find("select").val("");
        frm.find("input.custom-title").val("");
      };
          
      
      $('#mod-featuresview').on('hidden.bs.modal', function () {
            var option = $(this).attr("data-target");
            var target = "";
            if (option === 'source') { target = "#source_fields_tags"; }
            if (option === 'control') { target = "#control_fields_tags"; }
            $("#distinct_values a.active").each(function (id, fld) {                
                  $(target).tagsinput('add', $(fld).text());
            });
      });
      
      $('a[href="#geo_filter"]').on('shown.bs.tab', function (e) {
          addgeoFilter();
      });
      
      $( ".checkedurl" ).change(mv.checkURL);
      
    </script>


</body>
</html>
